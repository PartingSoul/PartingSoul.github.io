I"9€<h3 id="ä¸€-aidlæ–¹æ³•ä¼ é€’aidlæ¥å£">ä¸€. AIDLæ–¹æ³•ä¼ é€’AIDLæ¥å£</h3>

<p>â€‹	å‰é¢ä»‹ç»äº†<a href="https://partingsoul.github.io/2020/01/03/AIDL%E5%85%A5%E9%97%A8/">AIDLçš„åŸºæœ¬ç”¨æ³•</a>ï¼Œå…¶ä¸­æåˆ°ï¼ŒAIDLçš„æ–¹æ³•å½¢å‚å¯ä»¥æ˜¯åŸºæœ¬ç±»å‹ã€Stringã€Charquenceã€Parcelableã€Listä»¥åŠMapï¼Œå…¶å®è¿˜å¯ä»¥æ˜¯aidlæ¥å£ç±»å‹ã€‚</p>

<p>â€‹	è¿˜æ˜¯ä¹‹å‰ä¹¦æœ¬çš„ä¾‹å­ï¼Œè‹¥ç°åœ¨éœ€è¦å¢åŠ ä¸€ä¸ªéœ€æ±‚æœåŠ¡ç«¯æœ‰æ–°ä¹¦å¢åŠ æ—¶ï¼Œéœ€è¦é€šçŸ¥è®¢é˜…çš„å®¢æˆ·ç«¯æœ‰æ–°ä¹¦åˆ°æ¥ã€‚è‹¥ä¸¤è€…åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼Œå£°æ˜ä¸€ä¸ªé€šçŸ¥ä¹¦æœ¬å¢åŠ çš„æ¥å£ï¼Œå®¢æˆ·ç«¯å»æ³¨å†Œè¿™ä¸ªæ¥å£ï¼ŒæœåŠ¡ç«¯ä¿å­˜æ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œç„¶åæœåŠ¡ç«¯æœ‰ä¹¦æœ¬æ›´æ–°æ—¶ï¼Œéå†å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œé€šçŸ¥æ¯ä¸€ä¸ªå®¢æˆ·ç«¯æœ‰æ–°ä¹¦æ›´æ–°ã€‚ç°åœ¨ä¸¤è€…ä¸å†ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸€æ ·ï¼Œåªéœ€è¦å°†ç”¨Javaå£°æ˜çš„æ¥å£æ”¹ä¸ºaidlæ¥å£å³å¯ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// OnBookChangedCallback.aidl</span>
<span class="kn">package</span> <span class="nn">com.parting_soul.server</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.parting_soul.server.Book</span><span class="o">;</span>

<span class="kd">interface</span> <span class="nc">OnBookChangedCallback</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">onNewBookArrived</span><span class="o">(</span><span class="n">in</span> <span class="nc">Book</span> <span class="n">book</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å£°æ˜æ³¨å†Œæ¥å£çš„æ–¹æ³•ä»¥åŠè§£æ³¨å†Œçš„æ–¹æ³•å¹¶ä½¿ç”¨ä¸Šè¿°aidlæ¥å£ä½œä¸ºå½¢å‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// IBookManager2.aidl</span>
<span class="kn">package</span> <span class="nn">com.parting_soul.server</span><span class="o">;</span>

<span class="c1">// Declare any non-default types here with import statements</span>
<span class="kn">import</span> <span class="nn">com.parting_soul.server.Book</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.parting_soul.server.OnBookChangedCallback</span><span class="o">;</span>

<span class="kd">interface</span> <span class="nc">IBookManager2</span> <span class="o">{</span>
   <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="n">in</span>  <span class="nc">Book</span> <span class="n">book</span><span class="o">);</span>

   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">getBookLists</span><span class="o">();</span>

   <span class="c1">// æ³¨å†Œä¹¦æœ¬å˜åŒ–å›è°ƒ</span>
   <span class="kt">void</span> <span class="nf">registerBookChangedCallback</span><span class="o">(</span><span class="nc">OnBookChangedCallback</span> <span class="n">callback</span><span class="o">);</span>

   <span class="kt">void</span> <span class="nf">unregisterBookChangedCallback</span><span class="o">(</span><span class="nc">OnBookChangedCallback</span> <span class="n">callback</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æœåŠ¡ç«¯ä»£ç </p>

<ul>
  <li>æœåŠ¡ç«¯å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯éš”5sé’Ÿæ·»åŠ ä¸€æœ¬æ–°ä¹¦ï¼Œå¹¶é€šçŸ¥è®¢é˜…äº†ä¹¦ç±å˜åŒ–çš„å®¢æˆ·ç«¯</li>
  <li>åœ¨å®¢æˆ·ç«¯å–æ¶ˆè®¢é˜…æ—¶ï¼Œç§»é™¤å®¢æˆ·ç«¯çš„æ¥å£å›è°ƒ</li>
  <li>åœ¨å®¢æˆ·ç«¯é€€å‡ºæ—¶ï¼ŒåŠæ—¶å–æ¶ˆè®¢é˜…å¹¶ä¸”è§£ç»‘æœåŠ¡</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookManagerService2</span> <span class="kd">extends</span> <span class="nc">Service</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isDestroy</span><span class="o">;</span>

    <span class="cm">/**
     * ä¹¦æœ¬é›†åˆ
     */</span>
    <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">mBookLists</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="cm">/**
     * å›è°ƒé›†åˆ
     */</span>
    <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="nc">OnBookChangedCallback</span><span class="o">&gt;</span> <span class="n">mBookChangedCallbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;&gt;();</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">BookTask</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">IBinder</span> <span class="nf">onBind</span><span class="o">(</span><span class="nc">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">IBookManager2</span><span class="o">.</span><span class="na">Stub</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="nc">Book</span> <span class="n">book</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
                <span class="n">mBookLists</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
                <span class="n">notifyBookChanged</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">getBookLists</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">mBookLists</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBookChangedCallback</span><span class="o">(</span><span class="nc">OnBookChangedCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
                <span class="n">mBookChangedCallbacks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">callback</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unregisterBookChangedCallback</span><span class="o">(</span><span class="nc">OnBookChangedCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
                <span class="n">mBookChangedCallbacks</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">callback</span><span class="o">);</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"å½“å‰å‰©ä½™è¿æ¥æ•°ï¼š "</span> <span class="o">+</span> <span class="n">mBookChangedCallbacks</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
        <span class="n">isDestroy</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyBookChanged</span><span class="o">(</span><span class="nc">Book</span> <span class="n">book</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">OnBookChangedCallback</span> <span class="n">callback</span> <span class="o">:</span> <span class="n">mBookChangedCallbacks</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">callback</span><span class="o">.</span><span class="na">onNewBookArrived</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="c1">//ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯éš”5sæ·»åŠ ä¸€æœ¬æ–°ä¹¦</span>
    <span class="kd">class</span> <span class="nc">BookTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">isDestroy</span><span class="o">)</span> <span class="k">break</span><span class="o">;</span>
                <span class="nc">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="s">"Android ä¹¦ç± "</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="s">"æè¿°"</span><span class="o">);</span>
                <span class="n">mBookLists</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
                <span class="n">notifyBookChanged</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
                <span class="nc">SystemClock</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>å®¢æˆ·ç«¯ä»£ç </p>

<ul>
  <li>å®¢æˆ·ç«¯ç»‘å®šæœåŠ¡ç«¯çš„æœåŠ¡</li>
  <li>å½“æœåŠ¡ç»‘å®šæˆåŠŸåï¼Œå®¢æˆ·ç«¯è®¢é˜…æœåŠ¡ç«¯çš„ä¹¦ç±å˜åŒ–</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AIDLAdvancedActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isBound</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">IBookManager2</span> <span class="n">mBookManager</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">act_aidl_advanced</span><span class="o">);</span>

        <span class="c1">// ç»‘å®šæœåŠ¡</span>
        <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.parting_soul.server"</span><span class="o">,</span> <span class="s">"com.parting_soul.server.BookManagerService2"</span><span class="o">);</span>
        <span class="n">bindService</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">mServiceConnection</span><span class="o">,</span> <span class="nc">Context</span><span class="o">.</span><span class="na">BIND_AUTO_CREATE</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">view</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isBound</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">case</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">bt_insert</span><span class="o">:</span>
                <span class="n">insertBook</span><span class="o">();</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">bt_getBookLists</span><span class="o">:</span>
                <span class="n">getBookList</span><span class="o">();</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">getBookList</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="n">lists</span> <span class="o">=</span> <span class="n">mBookManager</span><span class="o">.</span><span class="na">getBookLists</span><span class="o">();</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">lists</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">//è¿œç¨‹è°ƒç”¨å¯èƒ½æ˜¯è€—æ—¶æ“ä½œï¼Œå®é™…ä¸Šåº”è¯¥æ”¾åœ¨å­çº¿ç¨‹ä¸­</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">insertBook</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
        <span class="n">mBookManager</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="s">"Android å¼€å‘è‰ºæœ¯æ¢ç´¢"</span><span class="o">,</span> <span class="s">"æŠ€æœ¯"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isBound</span> <span class="o">&amp;&amp;</span> <span class="n">mBookManager</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mBookManager</span><span class="o">.</span><span class="na">asBinder</span><span class="o">().</span><span class="na">isBinderAlive</span><span class="o">())</span> <span class="o">{</span>
              <span class="k">try</span> <span class="o">{</span>
                  <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">mOnBookChangedCallback</span><span class="o">.</span><span class="na">asBinder</span><span class="o">()</span> <span class="o">+</span> <span class="s">""</span><span class="o">);</span>
                  <span class="n">mBookManager</span><span class="o">.</span><span class="na">unregisterBookChangedCallback</span><span class="o">(</span><span class="n">mOnBookChangedCallback</span><span class="o">);</span>
              <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
              <span class="o">}</span>
          <span class="o">}</span>

          <span class="c1">// æ— è®ºè¿œç¨‹æœåŠ¡æœ‰æ²¡æœ‰æ²¡æ€æ­»ï¼Œéƒ½éœ€è¦è§£ç»‘ï¼Œå¦åˆ™ä¼šé€ æˆå†…å­˜æ³„æ¼</span>
          <span class="n">unbindService</span><span class="o">(</span><span class="n">mServiceConnection</span><span class="o">);</span>
          <span class="n">isBound</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
          <span class="n">mServiceConnection</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">ServiceConnection</span> <span class="n">mServiceConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceConnection</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"service connected"</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">mBookManager</span> <span class="o">=</span> <span class="nc">IBookManager2</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>

                <span class="n">mBookManager</span><span class="o">.</span><span class="na">registerBookChangedCallback</span><span class="o">(</span><span class="n">mOnBookChangedCallback</span><span class="o">);</span>
                <span class="n">isBound</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceDisconnected</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">isBound</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">private</span> <span class="nc">OnBookChangedCallback</span> <span class="n">mOnBookChangedCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OnBookChangedCallback</span><span class="o">.</span><span class="na">Stub</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNewBookArrived</span><span class="o">(</span><span class="nc">Book</span> <span class="n">book</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
            <span class="c1">//åœ¨binderçº¿ç¨‹ä¸­å›è°ƒ</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"æ–°ä¹¦åˆ°äº†: "</span> <span class="o">+</span> <span class="n">book</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">};</span>


<span class="o">}</span>
</code></pre></div></div>

<p>åœ¨æœåŠ¡ç«¯æ‰§è¡ŒæŒ‡å®šå®¢æˆ·ç«¯çš„å–æ¶ˆè®¢é˜…è¯·æ±‚åæ‰“å°äº†å½“å‰æœåŠ¡ç«¯æŒæœ‰çš„å®¢æˆ·ç«¯è®¢é˜…æ•°ï¼Œè‹¥å½“å‰å®¢æˆ·ç«¯é€€å‡ºï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æœåŠ¡ç«¯çš„è®¢é˜…æ•°æ‰“å°ç»“æœï¼š</p>

<p><img src="http://qagey3wv5.bkt.clouddn.com//binder.jpg" alt="æœåŠ¡ç«¯å‰©ä½™è¿æ¥æ•°" /></p>

<p>å®¢æˆ·ç«¯åœ¨é€€å‡ºæ—¶ï¼Œä¼šè°ƒç”¨unregisterBookChangedCallbackå–æ¶ˆè®¢é˜…ï¼Œä½†å‘ç°æœåŠ¡ç«¯è®¢é˜…æ•°å¹¶æ²¡æœ‰å˜åŒ–ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unregisterBookChangedCallback</span><span class="o">(</span><span class="nc">OnBookChangedCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
  <span class="n">mBookChangedCallbacks</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">callback</span><span class="o">);</span>
  <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"å½“å‰å‰©ä½™è¿æ¥æ•°ï¼š "</span> <span class="o">+</span> <span class="n">mBookChangedCallbacks</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unregisterBookChangedCallback</span><span class="o">(</span><span class="nc">OnBookChangedCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">mBookChangedCallbacks</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">callback</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"ä¸å­˜åœ¨è¯¥è¿æ¥"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="n">mBookChangedCallbacks</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">callback</span><span class="o">);</span>
  <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"å½“å‰å‰©ä½™è¿æ¥æ•°ï¼š "</span> <span class="o">+</span> <span class="n">mBookChangedCallbacks</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å†æ¬¡è¿›è¡ŒåŒæ ·çš„æ“ä½œï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡Œç»“æœ</p>

<p><img src="http://qagey3wv5.bkt.clouddn.com//binder-2.jpg" alt="æ‰§è¡Œç»“æœ" /></p>

<p>æˆ‘ä»¬å‘ç°å®¢æˆ·ç«¯ä¼ é€’åˆ°unregisterBookChangedCallbackçš„å›è°ƒæ¥å£ä¸åœ¨æˆ‘ä»¬ä¿å­˜çš„å®¢æˆ·ç«¯æ¥å£åˆ—è¡¨ä¸­ï¼Œå…¶å®è¿›ç¨‹é—´çš„æ•°æ®ä¼ é€’æœ¬è´¨æ˜¯å¯¹è±¡çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œæ¯•ç«Ÿä¸¤ä¸ªè¿›ç¨‹ä¸æ˜¯ä½äºåŒä¸€ä¸ªè™šæ‹Ÿæœºä¸­ï¼Œæ‹¥æœ‰ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥Binderä¼šå°†å®¢æˆ·ç«¯çš„ä¼ é€’è¿‡æ¥çš„å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡å‰¯æœ¬ã€‚</p>

<p>ç”±æ­¤å¼•å‡ºRemoteCallbackListï¼ŒRemoteCallbackListæ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºåˆ é™¤è·¨è¿›ç¨‹æ¥å£çš„ç±»ã€‚</p>

<p>ä¿®æ”¹æœåŠ¡ç«¯ä»£ç ï¼Œä½¿ç”¨RemoteCallbackListæ³¨å†Œå’Œè§£æ³¨å†Œaidlæ¥å£å‚æ•°</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBookChangedCallback</span><span class="o">(</span><span class="nc">OnBookChangedCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
  <span class="n">mRemoteCallbackList</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">callback</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unregisterBookChangedCallback</span><span class="o">(</span><span class="nc">OnBookChangedCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
  <span class="n">mRemoteCallbackList</span><span class="o">.</span><span class="na">unregister</span><span class="o">(</span><span class="n">callback</span><span class="o">);</span>
  <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"å½“å‰å‰©ä½™è¿æ¥æ•°ï¼š "</span> <span class="o">+</span> <span class="n">mBookChangedCallbacks</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™è¾¹å°±æœ‰ä¸€ä¸ªç–‘é—®äº†ï¼ŒRemoteCallbackListæ˜¯æ€ä¹ˆè§£å†³ä¸Šè¿°é—®é¢˜çš„ï¼Œçœ‹ä¸‹å®ƒçš„å®ç°ã€‚</p>

<p>å¯ä»¥çœ‹åˆ°RemoteCallbackListå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªMapï¼ŒKeyä¸ºaidlæ¥å£å¯¹åº”çš„IBinderï¼Œé”®å€¼ä¸ºå›è°ƒå¯¹è±¡çš„åŒ…è£…ç±»ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RemoteCallbackList</span><span class="o">&lt;</span><span class="no">E</span> <span class="kd">extends</span> <span class="nc">IInterface</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TAG</span> <span class="o">=</span> <span class="s">"RemoteCallbackList"</span><span class="o">;</span>

    <span class="c1">//ä¸€ä¸ªmap,IBinderä¸ºé”®ï¼Œå›è°ƒçš„åŒ…è£…ç±»ä¸ºkey</span>
    <span class="nd">@UnsupportedAppUsage</span>
    <span class="cm">/*package*/</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">IBinder</span><span class="o">,</span> <span class="nc">Callback</span><span class="o">&gt;</span> <span class="n">mCallbacks</span>
            <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">IBinder</span><span class="o">,</span> <span class="nc">Callback</span><span class="o">&gt;();</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">register</span><span class="o">(</span><span class="no">E</span> <span class="n">callback</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">cookie</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mCallbacks</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mKilled</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">logExcessiveCallbacks</span><span class="o">();</span>
            <span class="c1">//è·å–aidlæ¥å£çš„IBinderå¯¹è±¡</span>
            <span class="nc">IBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="na">asBinder</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Callback</span> <span class="n">cb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Callback</span><span class="o">(</span><span class="n">callback</span><span class="o">,</span> <span class="n">cookie</span><span class="o">);</span>
                <span class="n">binder</span><span class="o">.</span><span class="na">linkToDeath</span><span class="o">(</span><span class="n">cb</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                <span class="n">mCallbacks</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">binder</span><span class="o">,</span> <span class="n">cb</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">unregister</span><span class="o">(</span><span class="no">E</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mCallbacks</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//ç§»é™¤keyä¸ºIBinderå¯¹åº”çš„value</span>
            <span class="nc">Callback</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">mCallbacks</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">callback</span><span class="o">.</span><span class="na">asBinder</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cb</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">cb</span><span class="o">.</span><span class="na">mCallback</span><span class="o">.</span><span class="na">asBinder</span><span class="o">().</span><span class="na">unlinkToDeath</span><span class="o">(</span><span class="n">cb</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>éš¾é“åŒä¸€ä¸ªaidlå¯¹è±¡ä¼ é€’çš„æ—¶å€™ï¼Œè™½ç„¶è¯¥å¯¹è±¡ä¼šåœ¨æœåŠ¡ç«¯åˆ›å»ºååºåˆ—åŒ–åˆ›å»ºæ–°çš„å‰¯æœ¬ï¼Œä½†å®ƒçš„IBinderå¯¹è±¡æ˜¯ä¸€æ ·çš„ï¼Ÿ</p>

<p>åœ¨æ³¨å†Œå’Œè§£æ³¨å†Œæ—¶ï¼Œæˆ‘ä»¬æ‰“å°ä¸‹ä¸¤ä¸ªå¯¹è±¡ä»¥åŠå®ƒå¯¹åº”çš„IBinderå¯¹è±¡ã€‚</p>

<p>è¿è¡Œç»“æœï¼š</p>

<p><img src="http://qagey3wv5.bkt.clouddn.com//aidlå‚æ•°è§£ç»‘.jpg" alt="IBinder" /></p>

<p>å¯ä»¥çœ‹åˆ°è¿è¡Œç»“æœå’Œæˆ‘ä»¬çš„çŒœæƒ³ä¸€è‡´ï¼ŒåŒä¸€ä¸ªaidlå¯¹è±¡ä¼ é€’æ—¶ï¼ŒæœåŠ¡ç«¯ä¸­è¯¥aidlå¯¹è±¡çš„IBinderæ˜¯ä¸€æ ·çš„ã€‚</p>

<h3 id="äºŒ-æƒé™éªŒè¯">äºŒ. æƒé™éªŒè¯</h3>

<p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦é™åˆ¶å…¶ä»–åº”ç”¨æ¥ç»‘å®šæˆ‘ä»¬çš„æœåŠ¡ï¼Œè°ƒç”¨æœåŠ¡ç«¯çš„APIï¼Œæ­¤æ—¶å°±éœ€è¦ç”¨åˆ°æƒé™éªŒè¯ã€‚</p>

<h4 id="21-å£°æ˜ç»‘å®šserviceå¿…é¡»è¦æœ‰çš„æƒé™">2.1 å£°æ˜ç»‘å®šServiceå¿…é¡»è¦æœ‰çš„æƒé™</h4>

<p>åœ¨Serviceç«¯å£°æ˜ä¸€ä¸ªæƒé™</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;permission</span> <span class="na">android:name=</span><span class="s">"com.parting_soul.permission_BookManagerService"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>åœ¨Serviceç»„ä»¶æ·»åŠ å¯åŠ¨æˆ–è€…ç»‘å®šè¯¥æœåŠ¡æ‰€éœ€çš„æƒé™</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;service</span>
         <span class="na">android:name=</span><span class="s">".BookManagerService2"</span>
         <span class="na">android:exported=</span><span class="s">"true"</span>
         <span class="na">android:permission=</span><span class="s">"com.parting_soul.permission_BookManagerService"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<h4 id="22-åœ¨ontransactä¸­åšæƒé™éªŒè¯">2.2 åœ¨onTransactä¸­åšæƒé™éªŒè¯</h4>

<p>onTransact æ–¹æ³•ä¼šåœ¨å®¢æˆ·ç«¯è¿œç¨‹è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•å‰è¢«è°ƒç”¨ï¼Œå¯åœ¨è¯¥æ–¹æ³•åšåŒ…åæ ¡éªŒã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onTransact</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="nc">Parcel</span> <span class="n">data</span><span class="o">,</span> <span class="nc">Parcel</span> <span class="n">reply</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="n">packageName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="nc">String</span><span class="o">[]</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">getPackageManager</span><span class="o">().</span><span class="na">getPackagesForUid</span><span class="o">(</span><span class="n">getCallingUid</span><span class="o">());</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">packages</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">packages</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">packageName</span> <span class="o">=</span> <span class="n">packages</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">packageName</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
      <span class="o">!</span><span class="n">packageName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"com.parting_soul"</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"æƒé™éªŒè¯å¤±è´¥"</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onTransact</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">reply</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="ä¸‰-å¼‚å¸¸æƒ…å†µé‡æ–°è¿æ¥æœåŠ¡">ä¸‰. å¼‚å¸¸æƒ…å†µé‡æ–°è¿æ¥æœåŠ¡</h3>

<p>å¸¸ä¼šå‡ºç°è¿™ç§çŠ¶å†µï¼Œå®¢æˆ·ç«¯è¿˜éœ€è¦ä½¿ç”¨è¿œç¨‹çš„æœåŠ¡ï¼Œä½†æ˜¯è¿œç¨‹æœåŠ¡å› ä¸ºä¸€äº›åŸå› çªç„¶æ­»äº¡äº†ï¼Œè¿™æ—¶ä¸ºäº†å®¢æˆ·ç«¯çš„åŠŸèƒ½ä¸å—å½±å“ï¼Œéœ€è¦é‡æ–°è¿æ¥è¿œç¨‹çš„æœåŠ¡ã€‚</p>

<h4 id="31-onservicedisconnected">3.1 onServiceDisconnected</h4>

<p>è¯¥æ–¹æ³•ä¸æœåŠ¡çš„è¿æ¥ä¸¢å¤±æ—¶è°ƒç”¨ï¼Œé€šå¸¸æ˜¯æ‰˜ç®¡æœåŠ¡çš„è¿›ç¨‹è¢«æ€æ­»äº†ï¼Œå¯ä»¥åœ¨è¯¥æ–¹æ³•ä¸­é‡æ–°ç»‘å®šæœåŠ¡ï¼Œè¯¥æ–¹æ³•åœ¨ä¸»çº¿ç¨‹ä¸­è¢«å›è°ƒã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceDisconnected</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">isBound</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
  <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"disconnected"</span><span class="o">);</span>

  <span class="n">unbindService</span><span class="o">(</span><span class="n">mServiceConnection</span><span class="o">);</span>
  <span class="n">bindService</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="32-æ­»äº¡ä»£ç†">3.2 æ­»äº¡ä»£ç†</h4>

<p>å£°æ˜ä¸€ä¸ªæ­»äº¡ä»£ç†å¯¹è±¡ï¼Œå½“æœåŠ¡ç«¯Binderæ­»äº¡æ—¶binderDiedæ–¹æ³•ä¼šåœ¨å®¢æˆ·ç«¯Binderçº¿ç¨‹ä¸­å›è°ƒï¼Œæ­¤æ—¶å¯ä»¥ç§»é™¤ä¹‹å‰çš„æ­»äº¡ä»£ç†ï¼Œé‡æ–°ç»‘å®šæœåŠ¡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">IBinder</span><span class="o">.</span><span class="na">DeathRecipient</span> <span class="n">mDeathRecipient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IBinder</span><span class="o">.</span><span class="na">DeathRecipient</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">binderDied</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">//å½“Binderæ­»äº¡æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šå—æ”¶åˆ°å›è°ƒ</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"binderDied "</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mBookManager</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">//ç§»é™¤ç»‘å®šçš„æ­»äº¡ä»£ç†</span>
            <span class="n">mBookManager</span><span class="o">.</span><span class="na">asBinder</span><span class="o">().</span><span class="na">unlinkToDeath</span><span class="o">(</span><span class="n">mDeathRecipient</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="n">mBookManager</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="c1">// é‡æ–°ç»‘å®šæœåŠ¡</span>
            <span class="n">bindService</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">};</span>
</code></pre></div></div>

<p>åœ¨æœåŠ¡ç»‘å®šæˆåŠŸæ—¶ï¼Œéœ€è¦ç»™æœåŠ¡ç«¯çš„Binderç»‘å®šæ­»äº¡ä»£ç†</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"service connected"</span><span class="o">);</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">mBookManager</span> <span class="o">=</span> <span class="nc">IBookManager2</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>

    <span class="n">mBookManager</span><span class="o">.</span><span class="na">registerBookChangedCallback</span><span class="o">(</span><span class="n">mOnBookChangedCallback</span><span class="o">);</span>
    <span class="n">mBookManager</span><span class="o">.</span><span class="na">asBinder</span><span class="o">().</span><span class="na">linkToDeath</span><span class="o">(</span><span class="n">mDeathRecipient</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="n">isBound</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="å››-binderè¿æ¥æ± ">å››. Binderè¿æ¥æ± </h3>

<p>â€‹	åœ¨ä¹‹å‰çš„åšæ³•ä¸­ï¼Œä¸€ä¸ªä½¿ç”¨AIDLçš„ä¸šåŠ¡æœåŠ¡ç«¯éœ€è¦åˆ›å»ºä¸€ä¸ªServiceï¼Œè‹¥å¤šä¸ªä¸šåŠ¡éƒ½è¦ä½¿ç”¨AIDLï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªä½¿ç”¨AIDLçš„ä¸šåŠ¡æœåŠ¡ç«¯éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„Serviceï¼Œè¿™æ ·å¤šä¸ªServiceä¼šä½¿å¾—åº”ç”¨çœ‹èµ·å¼€ååˆ†è‡ƒè‚¿ï¼Œè€Œä¸”ä¸å¥½ç®¡ç†ï¼Œæ­¤æ—¶å°±å¯ä»¥ç”¨åˆ°Binderè¿æ¥æ± ï¼ŒæœåŠ¡ç«¯åªéœ€è¦å­˜åœ¨ä¸€ä¸ªServiceï¼Œå®¢æˆ·ç«¯é€šè¿‡ä¸šåŠ¡ç å»ä»æœåŠ¡ç«¯è·å–å¯¹åº”ä¸šåŠ¡çš„IBinderã€‚</p>

<p><img src="http://qagey3wv5.bkt.clouddn.com//binder.png" alt="Binderè¿æ¥æ± " /></p>

<h4 id="41-æœåŠ¡ç«¯">4.1 æœåŠ¡ç«¯</h4>

<h5 id="1-åˆ›å»ºå„ç§aidlæ–‡ä»¶ä»¥åŠå…·ä½“ä¸šåŠ¡çš„å®ç°">1. åˆ›å»ºå„ç§aidlæ–‡ä»¶ä»¥åŠå…·ä½“ä¸šåŠ¡çš„å®ç°</h5>

<p>è®¡ç®—æœåŠ¡</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// IComputer.aidl</span>
<span class="kn">package</span> <span class="nn">com.parting_soul.server</span><span class="o">;</span>

<span class="c1">// Declare any non-default types here with import statements</span>

<span class="kd">interface</span> <span class="nc">IComputer</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span><span class="kt">int</span> <span class="n">b</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å…·ä½“çš„ä¸šåŠ¡å®ç°</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ComputerImp</span> <span class="kd">extends</span> <span class="nc">IComputer</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è·å–æ¶ˆæ¯æœåŠ¡</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// IModel.aidl</span>
<span class="kn">package</span> <span class="nn">com.parting_soul.server</span><span class="o">;</span>

<span class="c1">// Declare any non-default types here with import statements</span>

<span class="kd">interface</span> <span class="nc">IModel</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">getMessage</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å…·ä½“çš„ä¸šåŠ¡å®ç°</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ComputerImp</span> <span class="kd">extends</span> <span class="nc">IComputer</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="2-åˆ›å»ºä¸€ä¸ªç”¨äºæä¾›ä¸Šè¿°ä¸šåŠ¡çš„ibinderçš„aidlæ–‡ä»¶">2. åˆ›å»ºä¸€ä¸ªç”¨äºæä¾›ä¸Šè¿°ä¸šåŠ¡çš„IBinderçš„AIDLæ–‡ä»¶</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// IBinderPool.aidl</span>
<span class="kn">package</span> <span class="nn">com.parting_soul.server</span><span class="o">;</span>

<span class="c1">// Declare any non-default types here with import statements</span>

<span class="kd">interface</span> <span class="nc">IBinderPool</span> <span class="o">{</span>
    <span class="kd">const</span> <span class="kt">int</span> <span class="no">BINDER_CODE_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="kd">const</span> <span class="kt">int</span> <span class="no">BINDER_CODE_COMPUTER</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

    <span class="kd">const</span> <span class="kt">int</span> <span class="no">BINDER_CODE_GET_MESSGE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="nc">IBinder</span> <span class="nf">queryBinder</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="3-åˆ›å»ºæœåŠ¡ç«¯çš„serviceæ ¹æ®å®¢æˆ·ç«¯çš„ä¸šåŠ¡codeè¿”å›å¯¹åº”çš„binder">3. åˆ›å»ºæœåŠ¡ç«¯çš„Serviceï¼Œæ ¹æ®å®¢æˆ·ç«¯çš„ä¸šåŠ¡codeè¿”å›å¯¹åº”çš„Binder</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BinderPoolService</span> <span class="kd">extends</span> <span class="nc">Service</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">IBinder</span> <span class="nf">onBind</span><span class="o">(</span><span class="nc">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">IBinderPool</span><span class="o">.</span><span class="na">Stub</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">IBinder</span> <span class="nf">queryBinder</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
                <span class="nc">IBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">switch</span> <span class="o">(</span><span class="n">code</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">case</span> <span class="nc">IBinderPool</span><span class="o">.</span><span class="na">BINDER_CODE_COMPUTER</span><span class="o">:</span>
                        <span class="n">binder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ComputerImp</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="nc">IBinderPool</span><span class="o">.</span><span class="na">BINDER_CODE_GET_MESSGE</span><span class="o">:</span>
                        <span class="n">binder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ModelImp</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">default</span><span class="o">:</span>
                        <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">binder</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="42-å®¢æˆ·ç«¯">4.2 å®¢æˆ·ç«¯</h4>

<p>Binderè¿æ¥æ± ï¼šä¸»è¦ç”¨äºä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥ä»¥åŠæä¾›è·å–å¯¹åº”ä¸šåŠ¡Binderçš„API</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BinderPool</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">BinderPool</span> <span class="n">sBinderPool</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Context</span> <span class="n">mContext</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isBind</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">IBinderPool</span> <span class="n">mIBinderPool</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">BinderPool</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">BinderPool</span> <span class="nf">getInstance</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sBinderPool</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">BinderPool</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">sBinderPool</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sBinderPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BinderPool</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sBinderPool</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * ç»‘å®šæœåŠ¡ç«¯çš„Service
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.parting_soul.server"</span><span class="o">,</span> <span class="s">"com.parting_soul.server.BinderPoolService"</span><span class="o">);</span>
        <span class="n">mContext</span><span class="o">.</span><span class="na">bindService</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">mServiceConnection</span><span class="o">,</span> <span class="nc">Context</span><span class="o">.</span><span class="na">BIND_AUTO_CREATE</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å–æ¶ˆç»‘å®š
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">disconnect</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isBind</span> <span class="o">&amp;&amp;</span> <span class="n">mIBinderPool</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mIBinderPool</span><span class="o">.</span><span class="na">asBinder</span><span class="o">().</span><span class="na">isBinderAlive</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">mIBinderPool</span><span class="o">.</span><span class="na">asBinder</span><span class="o">().</span><span class="na">unlinkToDeath</span><span class="o">(</span><span class="n">mDeathRecipient</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">mContext</span><span class="o">.</span><span class="na">unbindService</span><span class="o">(</span><span class="n">mServiceConnection</span><span class="o">);</span>
        <span class="n">isBind</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * æ ¹æ®ä¸šåŠ¡code è·å–æŒ‡å®šçš„IBinder
     *
     * @param code
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">IBinder</span> <span class="nf">queryBinder</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">IBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">binder</span> <span class="o">=</span> <span class="n">mIBinderPool</span><span class="o">.</span><span class="na">queryBinder</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">binder</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">ServiceConnection</span> <span class="n">mServiceConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceConnection</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">mIBinderPool</span> <span class="o">=</span> <span class="nc">IBinderPool</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
                <span class="n">mIBinderPool</span><span class="o">.</span><span class="na">asBinder</span><span class="o">().</span><span class="na">linkToDeath</span><span class="o">(</span><span class="n">mDeathRecipient</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                <span class="n">isBind</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"æœåŠ¡è¿æ¥æˆåŠŸ"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceDisconnected</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">isBind</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>


    <span class="cm">/**
     * æ­»äº¡ä»£ç†
     */</span>
    <span class="kd">private</span> <span class="nc">IBinder</span><span class="o">.</span><span class="na">DeathRecipient</span> <span class="n">mDeathRecipient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IBinder</span><span class="o">.</span><span class="na">DeathRecipient</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">binderDied</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">disconnect</span><span class="o">();</span>
            <span class="n">connect</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">};</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å®¢æˆ·ç«¯è°ƒç”¨(æœåŠ¡ç«¯çš„æ–¹æ³•å¯èƒ½æ˜¯è€—æ—¶æ“ä½œï¼Œå› æ­¤æ”¾åœ¨å­çº¿ç¨‹ä¸­)</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">IBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="n">mBinderPool</span><span class="o">.</span><span class="na">queryBinder</span><span class="o">(</span><span class="nc">IBinderPool</span><span class="o">.</span><span class="na">BINDER_CODE_COMPUTER</span><span class="o">);</span>
        <span class="nc">IComputer</span> <span class="n">computer</span> <span class="o">=</span> <span class="nc">IComputer</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">binder</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"è®¡ç®—ç»“æœ: a + b = "</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="äº”-aidl-javaå±‚æºç åˆ†æ">äº”. AIDL Javaå±‚æºç åˆ†æ</h3>

<p>å½“å®¢æˆ·ç«¯è°ƒç”¨bindServiceæ—¶ï¼ŒæœåŠ¡ç«¯ä¼šè¿”å›ä¸€ä¸ªåŒ…å«æœåŠ¡ç«¯ä¸šåŠ¡çš„Binderå¯¹è±¡ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡è¯¥Binderå¯¹è±¡è°ƒç”¨æœåŠ¡ç«¯æä¾›çš„æœåŠ¡ã€‚æˆ‘ä»¬åœ¨Javaå±‚æ¥çœ‹çœ‹å®ƒçš„å®ç°æ–¹å¼ã€‚</p>

<p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªIBookManager2 aidlæ¥å£ï¼Œç”¨äºåšè¿›ç¨‹é—´çš„é€šä¿¡ã€‚</p>

<p>æˆ‘ä»¬å£°æ˜äº†IBookManager2è¿™ä¸ªaidlæ–‡ä»¶åï¼Œç¼–è¯‘é¡¹ç›®ï¼Œé¡¹ç›®ä¼šåœ¨æŒ‡å®šçš„æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªIBookManager2ç±»ã€‚</p>

<p><img src="http://qagey3wv5.bkt.clouddn.com//aidlç±»ç”Ÿæˆä½ç½®.jpg" alt="aidlç±»ç”Ÿæˆè·¯å¾„" /></p>

<p>è¿™ä¸ªç”Ÿæˆçš„IBookManager2ç±»çš„UMLç±»å›¾å¦‚ä¸‹ï¼š</p>

<p><img src="http://qagey3wv5.bkt.clouddn.com//aidl.png" alt="aidlç”Ÿæˆç±»UML" /></p>

<p>å¯ä»¥çœ‹åˆ°æœ‰å‡ ä¸ªæ ¸å¿ƒç±»ï¼š</p>

<ul>
  <li>IBookManager2ï¼š æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç»§æ‰¿äº†IInterfaceï¼Œè¯¥ç±»å®šä¹‰æœåŠ¡ç«¯å¼€æ”¾ç»™å¤–éƒ¨çš„æ¥å£ï¼Œä¹Ÿå°±æ˜¯aidlæ–‡ä»¶ä¸­å®šä¹‰çš„æ–¹æ³•</li>
  <li>Stubï¼š æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°äº†IBookManager2æ¥å£ä»¥åŠç»§æ‰¿äº†Binderç±»ï¼Œä¸€èˆ¬æœåŠ¡ç«¯Serviceçš„onBindæ–¹æ³•è¿”å›è¯¥æŠ½è±¡ç±»çš„å­ç±»å®ä¾‹ï¼Œåœ¨å­ç±»ç¤ºä¾‹ä¸­å®ç°äº†å…·ä½“æœåŠ¡ç«¯æä¾›çš„æœåŠ¡ã€‚åœ¨å®¢æˆ·ç«¯è°ƒç”¨bindServiceæ—¶ï¼ŒæœåŠ¡ç«¯ä¼šå°†è¯¥Binderè¿”å›è‡³å®¢æˆ·ç«¯ï¼Œä½¿å¾—å®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨æœåŠ¡ç«¯æä¾›çš„æ–¹æ³•ã€‚</li>
  <li>Proxy: æ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œå®ç°äº†IBookManager2æ¥å£ï¼Œè¿™ä¸ªç±»ä½œç”¨åœ¨å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡è¯¥ç±»å»è°ƒç”¨æœåŠ¡ç«¯çš„æ–¹æ³•(å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­)</li>
</ul>

<h4 id="51-æœåŠ¡ç«¯ä»£ç ">5.1 æœåŠ¡ç«¯ä»£ç </h4>

<p>é¦–å…ˆçœ‹Stubç±»ï¼ŒæœåŠ¡ç«¯Serviceè¦ç»™å®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼Œéœ€è¦åœ¨onBindæ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªIBinderå¯¹è±¡ï¼ŒStubæ˜¯ä¸€ä¸ªç»§æ‰¿äº†Binderç±»ï¼Œå®ç°äº†IBookManager2çš„æŠ½è±¡ç±»ï¼Œåœ¨Serviceçš„onBindæ–¹æ³•ä¸­éœ€è¦è¿”å›ä¸€ä¸ªè¯¥ç±»çš„å®ç°ç±»ï¼Œåœ¨å®ç°ç±»ä¸­ä¹¦å†™å…·ä½“çš„æœåŠ¡é€»è¾‘ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * ç»§æ‰¿äº†Binderç±»ï¼Œå®ç°äº†IBookManager2æ¥å£
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Stub</span> <span class="kd">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Binder</span> <span class="kd">implements</span> <span class="nc">IBookManager2</span> <span class="o">{</span>

  <span class="cm">/**
   * Binderçš„å”¯ä¸€æ ‡è¯†ç¬¦
   */</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DESCRIPTOR</span> <span class="o">=</span> <span class="s">"com.parting_soul.server.IBookManager2"</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Stub</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//ç»™Binderæ·»åŠ æ–‡ä»¶æè¿°ç¬¦</span>
    <span class="k">this</span><span class="o">.</span><span class="na">attachInterface</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">DESCRIPTOR</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
   * å°†Binderå¯¹è±¡è½¬åŒ–ä¸ºIBookManager2æ¥å£
   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">IBookManager2</span> <span class="nf">asInterface</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IBinder</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//åˆ¤æ–­å½“å‰æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯æ˜¯å¦åœ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œè‹¥åœ¨ä¸€è¿›ç¨‹ï¼Œä¼šé€šè¿‡æè¿°ç¬¦æ‰¾åˆ°Binder</span>
    <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IInterface</span> <span class="n">iin</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">queryLocalInterface</span><span class="o">(</span><span class="no">DESCRIPTOR</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(((</span><span class="n">iin</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">iin</span> <span class="k">instanceof</span> <span class="nc">IBookManager2</span><span class="o">)))</span> <span class="o">{</span>
      <span class="c1">// IInterfaceä¸ä¸ºç©ºè¡¨ç¤ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­</span>
      <span class="k">return</span> <span class="o">((</span><span class="nc">IBookManager2</span><span class="o">)</span> <span class="n">iin</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ï¼Œè¿”å›ä¸€ä¸ªç”¨äºå’ŒæœåŠ¡ç«¯é€šä¿¡çš„ä»£ç†ç±»</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Stub</span><span class="o">.</span><span class="na">Proxy</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IBinder</span> <span class="nf">asBinder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>


  <span class="cm">/**
         * è¯¥æ–¹æ³•åœ¨æœåŠ¡ç«¯è¢«è°ƒç”¨
         *
         * @param code  å®¢æˆ·ç«¯è°ƒç”¨æ–¹æ³•çš„æ ‡è¯†ç¬¦
         * @param data  ç”¨äºè·å–æ–¹æ³•å‚æ•°çš„Parcel
         * @param reply ç”¨äºå†™æ–¹æ³•è¿”å›å€¼çš„Parcel
         * @param flags flagä¸º0æ ‡è¯†æ­£å¸¸çš„RPC
         * @return è¿”å›false, å®¢æˆ·ç«¯çš„è¯·æ±‚ä¼šå¤±è´¥
         * @throws android.os.RemoteException
         */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onTransact</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">data</span><span class="o">,</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">reply</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">RemoteException</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">descriptor</span> <span class="o">=</span> <span class="no">DESCRIPTOR</span><span class="o">;</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">code</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nl">INTERFACE_TRANSACTION:</span> <span class="o">{</span>
        <span class="n">reply</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">case</span> <span class="nl">TRANSACTION_insert:</span> <span class="o">{</span>
        <span class="n">data</span><span class="o">.</span><span class="na">enforceInterface</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
        <span class="n">com</span><span class="o">.</span><span class="na">parting_soul</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">Book</span> <span class="n">_arg0</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="na">readInt</span><span class="o">()))</span> <span class="o">{</span>
          <span class="c1">// book å½¢å‚ä¸ä¸ºç©ºï¼Œåˆ™ä»Parcelä¸­ååºåˆ—åŒ–å‡ºBookå¯¹è±¡</span>
          <span class="n">_arg0</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">parting_soul</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">Book</span><span class="o">.</span><span class="na">CREATOR</span><span class="o">.</span><span class="na">createFromParcel</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">_arg0</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// è°ƒç”¨æ’å…¥æ–¹æ³•</span>
        <span class="k">this</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">_arg0</span><span class="o">);</span>
        <span class="n">reply</span><span class="o">.</span><span class="na">writeNoException</span><span class="o">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">case</span> <span class="nl">TRANSACTION_getBookLists:</span> <span class="o">{</span>
        <span class="o">...</span>
          <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">case</span> <span class="nl">TRANSACTION_registerBookChangedCallback:</span> <span class="o">{</span>
        <span class="o">...</span>
          <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">case</span> <span class="nl">TRANSACTION_unregisterBookChangedCallback:</span> <span class="o">{</span>
        <span class="o">...</span>
          <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">default</span><span class="o">:</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onTransact</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">reply</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>è¯¥ç±»ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•éœ€è¦æ³¨æ„asInterfaceæ–¹æ³•ä¸onTransactæ–¹æ³•</p>

<p>æˆ‘ä»¬çŸ¥é“ï¼Œè¦å®ç°IPCï¼Œéœ€è¦åŒæ—¶åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ”¾å…¥aidlæ–‡ä»¶ï¼Œå¹¶ä¸”ä¸¤è€…ç¼–è¯‘ç”Ÿæˆçš„aidlç±»ä»£ç æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤ç”Ÿæˆçš„ä»£ç ä¸­ä¸€éƒ¨åˆ†æœåŠ¡ç«¯çš„APIï¼Œä¸€éƒ¨åˆ†æ˜¯å®¢æˆ·ç«¯çš„APIã€‚</p>

<p><strong>asInterfaceæ–¹æ³•ï¼š</strong> è¯¥æ–¹æ³•ä¸»è¦æ˜¯ç”¨äºå°†IBinderè½¬åŒ–ä¸ºIBookManager2å¯¹è±¡ã€‚è‹¥æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è°ƒç”¨ä¼šå‡ºç°ä¸åŒçš„æƒ…å†µï¼Œå› æ­¤å¯ä»¥é€šè¿‡Binderçš„å”¯ä¸€æ ‡è¯†ç¬¦åˆ¤æ–­æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ˜¯å¦åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œè‹¥åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œç›´æ¥å°†Binderå¯¹è±¡å¼ºè½¬ä¸ºIBookManager2ï¼›è‹¥ä¸æ˜¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯éœ€è¦é€šè¿‡Binderä¸æœåŠ¡ç«¯è¿›è¡Œé€šä¿¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªä»£ç†çš„IBookManager2å¯¹è±¡ï¼Œç”¨äºå‘èµ·RPCæ“ä½œã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
   * å°†Binderå¯¹è±¡è½¬åŒ–ä¸ºIBookManager2æ¥å£
   */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">IBookManager2</span> <span class="nf">asInterface</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IBinder</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">//åˆ¤æ–­å½“å‰æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯æ˜¯å¦åœ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œè‹¥åœ¨ä¸€è¿›ç¨‹ï¼Œä¼šé€šè¿‡æè¿°ç¬¦æ‰¾åˆ°Binder</span>
  <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IInterface</span> <span class="n">iin</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">queryLocalInterface</span><span class="o">(</span><span class="no">DESCRIPTOR</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(((</span><span class="n">iin</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">iin</span> <span class="k">instanceof</span> <span class="nc">IBookManager2</span><span class="o">)))</span> <span class="o">{</span>
    <span class="c1">// IInterfaceä¸ä¸ºç©ºè¡¨ç¤ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­</span>
    <span class="k">return</span> <span class="o">((</span><span class="nc">IBookManager2</span><span class="o">)</span> <span class="n">iin</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">//æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ï¼Œè¿”å›ä¸€ä¸ªç”¨äºå’ŒæœåŠ¡ç«¯é€šä¿¡çš„ä»£ç†ç±»</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nc">Stub</span><span class="o">.</span><span class="na">Proxy</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä¸Šè¿°æè¿°ä¸­å‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆå½“å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸å†åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯å°±æ— æ³•é€šè¿‡Binderçš„å”¯ä¸€æ ‡è¯†ç¬¦è·å–Binderå¯¹è±¡ï¼Ÿå…¶å®å®¢æˆ·ç«¯ä½¿ç”¨çš„IBinderæ˜¯ä¸€ä¸ªä»£ç†çš„IBinderå¯¹è±¡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">BinderProxy</span> <span class="kd">implements</span> <span class="nc">IBinder</span> <span class="o">{</span>

    <span class="c1">// ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘nativeä¸­Ibinderå¯¹è±¡ä»¥åŠDeathRecipientListçš„å†…å­˜ç©ºé—´</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">mNativeData</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">BinderProxy</span><span class="o">(</span><span class="kt">long</span> <span class="n">nativeData</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mNativeData</span> <span class="o">=</span> <span class="n">nativeData</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// å‘èµ·RPC</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">transact</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="nc">Parcel</span> <span class="n">data</span><span class="o">,</span> <span class="nc">Parcel</span> <span class="n">reply</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
    <span class="o">}</span>


    <span class="c1">// æ ¹æ®Binderå”¯ä¸€æ ‡è¯†ç¬¦è¿”å›IInterfaceï¼Œè¿™é‡Œå§‹ç»ˆè¿”å›null, ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå½“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸åœ¨ä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œè¿”å›ç»“æœä¸åŒçš„åŸå› </span>
    <span class="kd">public</span> <span class="nc">IInterface</span> <span class="nf">queryLocalInterface</span><span class="o">(</span><span class="nc">String</span> <span class="n">descriptor</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å®¢æˆ·ç«¯çš„IBinderå¯¹è±¡å…¶å®BinderProxyå¯¹è±¡ï¼Œåœ¨è¯¥å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°queryLocalInterfaceæ–¹æ³•è¿”å›çš„æ˜¯nullï¼Œè¿™ä¹Ÿå°±æ˜¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹æ—¶è°ƒç”¨queryLocalInterfaceæœ‰ä¸åŒè¿”å›å€¼çš„åŸå› ã€‚</p>

<p><strong>onTransactæ–¹æ³•ï¼š</strong> å½“å®¢æˆ·ç«¯å‘èµ·è¿œç¨‹è°ƒç”¨æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨æœåŠ¡ç«¯çš„Binderçº¿ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•çš„è¿”å›å€¼è‹¥ä¸ºtrueï¼Œæ ‡è¯†IPCæˆåŠŸï¼Œåä¹‹åˆ™è°ƒç”¨å¤±è´¥ã€‚</p>

<p>è¿™é‡Œä»¥å®¢æˆ·ç«¯è°ƒç”¨insertBookæ–¹æ³•ä¸ºä¾‹</p>

<ul>
  <li>ä»å†™å…¥å½¢å‚çš„Parcelè¯»å‡ºå½¢å‚</li>
  <li>è°ƒç”¨å…·ä½“çš„å®ç°æ–¹æ³•</li>
  <li>å°†è¿”å›ç»“æœå†™å…¥Parcel</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onTransact</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">data</span><span class="o">,</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">reply</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">RemoteException</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">descriptor</span> <span class="o">=</span> <span class="no">DESCRIPTOR</span><span class="o">;</span>
    <span class="c1">// codeç”¨äºæ ‡è¯†å®¢æˆ·ç«¯è°ƒç”¨çš„æ–¹æ³•</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">INTERFACE_TRANSACTION:</span> <span class="o">{</span>
            <span class="n">reply</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">case</span> <span class="nl">TRANSACTION_insert:</span> <span class="o">{</span>
            <span class="c1">// æ’å…¥ä¹¦ç±çš„æ–¹æ³•</span>
            <span class="n">data</span><span class="o">.</span><span class="na">enforceInterface</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
            <span class="n">com</span><span class="o">.</span><span class="na">parting_soul</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">Book</span> <span class="n">_arg0</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="na">readInt</span><span class="o">()))</span> <span class="o">{</span>
                <span class="c1">// book å½¢å‚ä¸ä¸ºç©ºï¼Œåˆ™ä»Parcelä¸­ååºåˆ—åŒ–å‡ºBookå¯¹è±¡</span>
                <span class="n">_arg0</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">parting_soul</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">Book</span><span class="o">.</span><span class="na">CREATOR</span><span class="o">.</span><span class="na">createFromParcel</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">_arg0</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// è°ƒç”¨æ’å…¥æ–¹æ³•</span>
            <span class="k">this</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">_arg0</span><span class="o">);</span>
            <span class="n">reply</span><span class="o">.</span><span class="na">writeNoException</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="52-å®¢æˆ·ç«¯ä»£ç ">5.2 å®¢æˆ·ç«¯ä»£ç </h4>

<p>ç°åœ¨æ¥çœ‹å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯åœ¨ç»‘å®šServiceæˆåŠŸåï¼Œä¼šè·å–åˆ°ä¸€ä¸ªIBinderå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç±»å‹ä¸ºBindProxyï¼Œæ˜¯æœåŠ¡ç«¯è¿”å›Binderçš„ä»£ç†ç±»ã€‚ç”±äºå®¢æˆ·ç«¯éœ€è¦è°ƒç”¨æœåŠ¡ç«¯æä¾›çš„APIï¼Œæ‰€ä»¥éœ€è¦å°†è¯¥BindProxyå¯¹è±¡è½¬åŒ–ä¸ºå…·ä½“çš„æ¥å£ç±»å‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">IBookManager2</span> <span class="nf">asInterface</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IBinder</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">((</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">//åˆ¤æ–­å½“å‰æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯æ˜¯å¦åœ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œè‹¥åœ¨ä¸€è¿›ç¨‹ï¼Œä¼šé€šè¿‡æè¿°ç¬¦æ‰¾åˆ°Binder</span>
  <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IInterface</span> <span class="n">iin</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">queryLocalInterface</span><span class="o">(</span><span class="no">DESCRIPTOR</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(((</span><span class="n">iin</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">iin</span> <span class="k">instanceof</span> <span class="nc">IBookManager2</span><span class="o">)))</span> <span class="o">{</span>
    <span class="c1">// IInterfaceä¸ä¸ºç©ºè¡¨ç¤ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­</span>
    <span class="k">return</span> <span class="o">((</span><span class="nc">IBookManager2</span><span class="o">)</span> <span class="n">iin</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">//æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹ï¼Œè¿”å›ä¸€ä¸ªç”¨äºå’ŒæœåŠ¡ç«¯é€šä¿¡çš„ä»£ç†ç±»</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nc">Stub</span><span class="o">.</span><span class="na">Proxy</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä»ä¸Šè¿°ä»£ç å¯ä»¥çŸ¥é“ï¼Œå½“å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸å†åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯å¾—åˆ°çš„æ˜¯ä¸€ä¸ªStub.Proxyå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å®ç°äº†IBookManager2å¹¶ä¸”æœ‰ä¸€ä¸ªä¸ºç±»å‹ä¸ºBindProxyçš„æˆå‘˜å±æ€§ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡çš„ä»£ç†ç±»ï¼Œå…·ä½“ç”¨äºçš„é€šä¿¡å¯¹è±¡æ˜¯æˆå‘˜å±æ€§IBinder
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Proxy</span> <span class="kd">implements</span> <span class="nc">IBookManager2</span> <span class="o">{</span>
    <span class="c1">// ç”¨äºé€šä¿¡çš„å…·ä½“å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç±»å‹ä¸ºBinderProxy</span>
    <span class="kd">private</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IBinder</span> <span class="n">mRemote</span><span class="o">;</span>

    <span class="nc">Proxy</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IBinder</span> <span class="n">remote</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mRemote</span> <span class="o">=</span> <span class="n">remote</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">IBinder</span> <span class="nf">asBinder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mRemote</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getInterfaceDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">DESCRIPTOR</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">parting_soul</span><span class="o">.</span><span class="na">server</span><span class="o">.</span><span class="na">Book</span> <span class="n">book</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">RemoteException</span> <span class="o">{</span>
        <span class="c1">// åˆ›å»ºä¸€ä¸ªç”¨äºå†™å…¥æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼çš„åŒ…è£¹å¯¹è±¡ï¼Œè¯¥åŒ…è£¹å¯¹è±¡å¯é€šè¿‡Binderå‘é€</span>
        <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">_data</span> <span class="o">=</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
        <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">_reply</span> <span class="o">=</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// å†™å…¥Binderå”¯ä¸€æ ‡è¯†</span>
            <span class="n">_data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="no">DESCRIPTOR</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">book</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">//å‚æ•°ä¸ä¸ºç©ºï¼Œåˆ™å†™å…¥å‚æ•°</span>
                <span class="n">_data</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                <span class="n">book</span><span class="o">.</span><span class="na">writeToParcel</span><span class="o">(</span><span class="n">_data</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// å¯¹è±¡å‚æ•°ä¸ºç©ºï¼Œç”¨0æ ‡è¯†</span>
                <span class="n">_data</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// å‘èµ·è¿œç¨‹è°ƒç”¨ï¼ŒåŒæ—¶å½“å‰çº¿ç¨‹è¢«æŒ‚èµ·</span>
            <span class="kt">boolean</span> <span class="n">_status</span> <span class="o">=</span> <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="nc">Stub</span><span class="o">.</span><span class="na">TRANSACTION_insert</span><span class="o">,</span> <span class="n">_data</span><span class="o">,</span> <span class="n">_reply</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">_status</span> <span class="o">&amp;&amp;</span> <span class="n">getDefaultImpl</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// è‹¥è¿œç¨‹è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤çš„æ–¹å¼è°ƒç”¨æ–¹æ³•</span>
                <span class="n">getDefaultImpl</span><span class="o">().</span><span class="na">insert</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// è¯»å–è¿”å›å€¼ä¸­çš„å¼‚å¸¸æƒ…å†µ</span>
            <span class="n">_reply</span><span class="o">.</span><span class="na">readException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">_reply</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
            <span class="n">_data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

 		<span class="o">...</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">IBookManager2</span> <span class="n">sDefaultImpl</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å®¢æˆ·ç«¯å¯ä»¥è°ƒæœåŠ¡ç«¯çš„æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†Proxyç±»ä¸­çš„æ–¹æ³•ï¼Œä¾‹å¦‚insertæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­åˆ›å»ºä¸€ä¸ªç”¨äºå†™æ–¹æ³•å½¢å‚çš„Parcelä»¥åŠä¸€ä¸ªç”¨äºå†™å…¥è¿”å›å€¼çš„Parcelå¯¹è±¡ï¼Œç„¶åé€šè¿‡IBinderå¯¹è±¡å‘èµ·RPCï¼ŒåŒæ—¶å½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·(è¿™ä¹Ÿæ˜¯å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•æ—¶ï¼Œå°½å¯èƒ½çš„æ”¾åœ¨å­çº¿ç¨‹ä¸­ï¼Œé˜²æ­¢ä¸»çº¿ç¨‹è¢«é˜»å¡å‘ç”ŸANR)ã€‚</p>

<h4 id="53-æ€»ç»“">5.3 æ€»ç»“</h4>

<p><img src="http://qagey3wv5.bkt.clouddn.com//aidl Javaå±‚æµç¨‹.png" alt="AIDL Javaå±‚æµç¨‹" /></p>

<ol>
  <li>
    <p>å®¢æˆ·ç«¯ç»‘å®šæœåŠ¡ç«¯çš„Serviceï¼Œç»‘å®šæˆåŠŸåæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªä»£ç†çš„IBinderå¯¹è±¡</p>
  </li>
  <li>å°†æœåŠ¡ç«¯è¿”å›çš„IBinderå¯¹è±¡è½¬åŒ–æˆæœåŠ¡ç«¯APIæ¥å£å¯¹è±¡ã€‚è‹¥å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œç›´æ¥å°†IBinderå¯¹è±¡å¼ºè½¬ä¸ºæ¥å£å¯¹è±¡ï¼›è‹¥ä¸åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œè¿”å›ä¸€ä¸ªè®©å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯APIçš„Proxyç±»</li>
  <li>å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯APIå®é™…ä¸Šæ˜¯é€šè¿‡è°ƒç”¨æœ¬åœ°çš„Proxyç±»ï¼Œå°†æ–¹æ³•è°ƒç”¨æ‰€éœ€çš„å½¢å‚å†™å…¥Parcelï¼Œè°ƒç”¨æ–¹æ³•æ—¶ï¼Œé€šè¿‡Binderå‘é€è¯¥Parcelï¼Œé€šè¿‡å®¢æˆ·ç«¯çº¿ç¨‹è¢«æŒ‚èµ·</li>
  <li>æœåŠ¡ç«¯çš„onTransactæ–¹æ³•è¢«è°ƒç”¨ï¼Œå°†æ–¹æ³•å½¢å‚ä»Parcelä¸­è¯»å‡ºï¼Œè°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼Œè‹¥æœ‰è¿”å›å€¼ï¼Œå°†è¿”å›å€¼å†™å…¥Parcelï¼Œå®ŒæˆæœåŠ¡ç«¯çš„è°ƒç”¨</li>
  <li>å®¢æˆ·ç«¯æŒ‚èµ·çš„çº¿ç¨‹è¢«å”¤é†’ï¼Œä»Parcelä¸­è¯»å‡ºè¿”å›å€¼</li>
</ol>
:ET