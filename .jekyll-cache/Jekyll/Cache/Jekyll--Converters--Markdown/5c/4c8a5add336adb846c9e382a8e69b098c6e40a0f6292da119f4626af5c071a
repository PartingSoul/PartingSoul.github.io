I"ƒº<h1 id="ä¸€-æ¦‚è¿°">ä¸€. æ¦‚è¿°</h1>

<p><a href="https://github.com/JakeWharton/butterknife">ButterKnife</a> æ˜¯ä¸€ä¸ªä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œä¸»è¦ç”¨äºç»‘å®šViewã€ä¸€äº›Viewçš„äº‹ä»¶ç­‰ç­‰ï¼Œå¯ä»¥å¤§å¤§å‡å°‘findViewByIdä»¥åŠè®¾ç½®Viewäº‹ä»¶ç›‘å¬å™¨çš„ä»£ç ï¼Œå¹¶ä¸”æ¡†æ¶çš„æ€§èƒ½ç›¸æ¯”äºä¼ ç»Ÿå†™æ³•ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„æŸè€—ã€‚</p>

<h1 id="äºŒ-ç®€å•ä½¿ç”¨">äºŒ. ç®€å•ä½¿ç”¨</h1>

<p>ButterKnifeçš„ç”¨æ³•ååˆ†ç®€å•</p>

<p>å¯¼å…¥ä¾èµ–</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">android</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="c1">// Butterknife requires Java 8.</span>
  <span class="n">compileOptions</span> <span class="o">{</span>
    <span class="n">sourceCompatibility</span> <span class="n">JavaVersion</span><span class="o">.</span><span class="na">VERSION_1_8</span>
    <span class="n">targetCompatibility</span> <span class="n">JavaVersion</span><span class="o">.</span><span class="na">VERSION_1_8</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">dependencies</span> <span class="o">{</span>
  <span class="n">implementation</span> <span class="s1">'com.jakewharton:butterknife:10.2.0'</span>
  <span class="n">annotationProcessor</span> <span class="s1">'com.jakewharton:butterknife-compiler:10.2.0'</span>
<span class="o">}</span>
</code></pre></div></div>

<p>åœ¨ä»£ç ä¸­ä½¿ç”¨</p>

<p>åœ¨éœ€è¦æ³¨å…¥å€¼çš„å±æ€§æˆ–è€…æ–¹æ³•ä¸Šä½¿ç”¨å¯¹åº”çš„æ³¨è§£ä¿®é¥°ï¼Œç„¶ååœ¨onCreateä¸­å¯åŠ¨æ³¨è§£å¤„ç†å·¥å…·ï¼Œç„¶ååœ¨onDestroyä¸­ç§»é™¤å¯¹å±æ€§çš„ç»‘å®šã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="nd">@BindView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cl</span><span class="o">)</span>
    <span class="nc">ConstraintLayout</span> <span class="n">cl</span><span class="o">;</span>

    <span class="nd">@BindView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">bt</span><span class="o">)</span>
    <span class="nc">Button</span> <span class="n">bt</span><span class="o">;</span>

    <span class="nd">@BindString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">app_name</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">appName</span><span class="o">;</span>

    <span class="nd">@BindDrawable</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_launcher_background</span><span class="o">)</span>
    <span class="nc">Drawable</span> <span class="n">icon</span><span class="o">;</span>

    <span class="nd">@BindColor</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">colorAccent</span><span class="o">)</span>
    <span class="kt">int</span> <span class="n">color</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Unbinder</span> <span class="n">mUnbinder</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
        <span class="n">mUnbinder</span> <span class="o">=</span> <span class="nc">ButterKnife</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@OnClick</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">bt</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">onClick</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
        <span class="n">mUnbinder</span><span class="o">.</span><span class="na">unbind</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="ä¸‰-æºç åˆ†æ">ä¸‰. æºç åˆ†æ</h1>

<p>æˆ‘ä»¬å°†ä½¿ç”¨ä¸Šæ–¹çš„ä¾‹å­æ¥è®²è§£ButterKnifeï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æˆ‘ä»¬åœ¨ä¾‹å­ä¸­åšäº†å“ªäº›æ“ä½œ</p>

<ul>
  <li>é€šè¿‡BindViewå°†å¸ƒå±€ä¸­å¯¹åº”idçš„å¸ƒå±€ç»‘å®šåˆ°å¯¹åº”çš„View</li>
  <li>é€šè¿‡BindStringå°†ä¸€ä¸ªèµ„æºå­—ç¬¦ä¸²ç»‘å®šåˆ°ä¸€ä¸ªStringç±»å‹çš„å±æ€§</li>
  <li>é€šè¿‡BindDrawableå°†ä¸€ä¸ªèµ„æºç±»å‹çš„å›¾ç‰‡ç»‘å®šåˆ°ä¸€ä¸ªDrawableçš„å±æ€§</li>
  <li>é€šè¿‡BindColorå°†ä¸€ä¸ªé¢œè‰²ç»‘å®šåˆ°ä¸€ä¸ªintç±»å‹çš„å±æ€§</li>
  <li>é€šè¿‡OnClickä¸ºR.id.btå¯¹ç”¨çš„æ§ä»¶è®¾ç½®äº†ç‚¹å‡»äº‹ä»¶çš„æ–¹æ³•å›è°ƒ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="nd">@BindView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cl</span><span class="o">)</span>
    <span class="nc">ConstraintLayout</span> <span class="n">cl</span><span class="o">;</span>

    <span class="nd">@BindView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">bt</span><span class="o">)</span>
    <span class="nc">Button</span> <span class="n">bt</span><span class="o">;</span>

    <span class="nd">@BindString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">app_name</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">appName</span><span class="o">;</span>

    <span class="nd">@BindDrawable</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_launcher_background</span><span class="o">)</span>
    <span class="nc">Drawable</span> <span class="n">icon</span><span class="o">;</span>

    <span class="nd">@BindColor</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">colorAccent</span><span class="o">)</span>
    <span class="kt">int</span> <span class="n">color</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Unbinder</span> <span class="n">mUnbinder</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
        <span class="n">mUnbinder</span> <span class="o">=</span> <span class="nc">ButterKnife</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@OnClick</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">bt</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">onClick</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
        <span class="n">mUnbinder</span><span class="o">.</span><span class="na">unbind</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="31-viewbinding-ç±»">3.1 ViewBinding ç±»</h2>

<p>ä¸Šè¿°ä»£ç ä½¿ç”¨äº†ButterKnifeæ³¨è§£ï¼Œåœ¨ç¼–è¯‘æ—¶å°±ä¼šè¢«ç³»ç»Ÿæ‰«æåˆ°ï¼Œç„¶ååœ¨åŒçº§çš„åŒ…åç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ª[ç±»å]_ViewBindingçš„ä¸€ä¸ªç±»ã€‚</p>

<p><img src="http://qagey3wv5.bkt.clouddn.com//image.png" alt="image" /></p>

<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ç”Ÿæˆçš„MainActivity_ViewBindingç±»ï¼Œè¿™ä¸ªç±»ä»£ç ååˆ†ç®€å•ã€‚</p>

<ul>
  <li>å±æ€§ï¼š æœ‰ä¸€ä¸ªMainActivityçš„å±æ€§ï¼Œç”¨äºæŒæœ‰å¯¹MainActivityå¯¹è±¡çš„å¼•ç”¨ã€‚</li>
  <li>æ„é€ æ–¹æ³•ï¼šä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œåœ¨æ„é€ æ–¹æ³•å†…å¯¹MainActivityä¸­ä½¿ç”¨æ³¨è§£ä¿®é¥°çš„å±æ€§è¿›è¡Œèµ‹å€¼æˆ–ä¸ºæŒ‡å®šçš„æ§ä»¶è®¾ç½®ç›‘å¬å™¨</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity_ViewBinding</span> <span class="kd">implements</span> <span class="nc">Unbinder</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">MainActivity</span> <span class="n">target</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nc">View</span> <span class="n">view7f070042</span><span class="o">;</span>

  <span class="nd">@UiThread</span>
  <span class="kd">public</span> <span class="nf">MainActivity_ViewBinding</span><span class="o">(</span><span class="nc">MainActivity</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">target</span><span class="o">.</span><span class="na">getWindow</span><span class="o">().</span><span class="na">getDecorView</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@UiThread</span>
  <span class="kd">public</span> <span class="nf">MainActivity_ViewBinding</span><span class="o">(</span><span class="kd">final</span> <span class="nc">MainActivity</span> <span class="n">target</span><span class="o">,</span> <span class="nc">View</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">;</span>

    <span class="nc">View</span> <span class="n">view</span><span class="o">;</span>

    <span class="c1">// æ‰¾åˆ°idä¸ºR.id.clçš„æ§ä»¶ï¼Œç„¶åå°†å…¶èµ‹å€¼ç»™MainActivityä¸­çš„åä¸ºclçš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨BindViewä¿®é¥°ï¼Œæ³¨è§£å€¼ä¸ºR.id.clçš„æ§ä»¶</span>
    <span class="n">target</span><span class="o">.</span><span class="na">cl</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">findRequiredViewAsType</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cl</span><span class="o">,</span> <span class="s">"field 'cl'"</span><span class="o">,</span> <span class="nc">ConstraintLayout</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="c1">// åŒç† æ‰¾åˆ°idä¸º.id.btçš„æ§ä»¶ï¼Œå°†å…¶èµ‹å€¼ç»™MainActivityä¸­çš„åä¸ºbtçš„å±æ€§</span>
    <span class="n">view</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">findRequiredView</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">bt</span><span class="o">,</span> <span class="s">"field 'bt' and method 'onClick'"</span><span class="o">);</span>
    <span class="n">target</span><span class="o">.</span><span class="na">bt</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">castView</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">bt</span><span class="o">,</span> <span class="s">"field 'bt'"</span><span class="o">,</span> <span class="nc">Button</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">view7f070042</span> <span class="o">=</span> <span class="n">view</span><span class="o">;</span>
    <span class="c1">//ä¸ºR.id.btçš„æ§ä»¶è®¾ç½®ç›‘å¬å™¨</span>
    <span class="n">view</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">DebouncingOnClickListener</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">p0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">target</span><span class="o">.</span><span class="na">onClick</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">});</span>

    <span class="nc">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
    <span class="nc">Resources</span> <span class="n">res</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">();</span>
    <span class="c1">// å°†R.color.colorAccentå¯¹åº”çš„é¢œè‰²èµ‹å€¼ç»™MainActivityä¸­åä¸ºcolorçš„å±æ€§</span>
    <span class="n">target</span><span class="o">.</span><span class="na">color</span> <span class="o">=</span> <span class="nc">ContextCompat</span><span class="o">.</span><span class="na">getColor</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">colorAccent</span><span class="o">);</span>
    <span class="c1">// å°†R.drawable.ic_launcher_backgroundå¯¹åº”çš„å›¾ç‰‡èµ‹å€¼ç»™MainActivityä¸­åä¸ºiconçš„å±æ€§</span>
    <span class="n">target</span><span class="o">.</span><span class="na">icon</span> <span class="o">=</span> <span class="nc">ContextCompat</span><span class="o">.</span><span class="na">getDrawable</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_launcher_background</span><span class="o">);</span>
    <span class="c1">// å°†R.string.app_name å¯¹åº”çš„å­—ç¬¦ä¸²å€¼èµ‹å€¼ç»™MainActivityä¸­åä¸ºappNameçš„å±æ€§</span>
    <span class="n">target</span><span class="o">.</span><span class="na">appName</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">app_name</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="nd">@CallSuper</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unbind</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">MainActivity</span> <span class="n">target</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">target</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span><span class="s">"Bindings already cleared."</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c1">// ç§»é™¤è¢«BindViewä¿®é¥°çš„Viewæ§ä»¶çš„å¼•ç”¨</span>
    <span class="n">target</span><span class="o">.</span><span class="na">cl</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">target</span><span class="o">.</span><span class="na">bt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">// ç§»é™¤ç›‘å¬å™¨</span>
    <span class="n">view7f070042</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="n">view7f070042</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™é‡Œä»¥idä¸ºR.id.btçš„æ§ä»¶ä¸ºä¾‹è¿›è¡Œè®²è§£ï¼š</p>

<p>å¯ä»¥çœ‹åˆ°è¿™è¾¹é€šè¿‡Utilsè¿™ä¸ªå·¥å…·ç±»å»è·å–è¿™ä¸ªidçš„æ§ä»¶ï¼ŒfindRequiredViewæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªsourceä¸ºDecorViewå¯¹è±¡ï¼Œæ˜¯MainActivityçš„é¡¶çº§å®¹å™¨ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯éœ€è¦è·å–æ§ä»¶çš„idï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºæè¿°ä¿¡æ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">MainActivity_ViewBinding</span><span class="o">(</span><span class="kd">final</span> <span class="nc">MainActivity</span> <span class="n">target</span><span class="o">,</span> <span class="nc">View</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
 		<span class="o">...</span>
    <span class="n">view</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">findRequiredView</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">bt</span><span class="o">,</span> <span class="s">"field 'bt' and method 'onClick'"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹Utilså·¥å…·ç±»ï¼Œä¸éš¾å‘ç°ï¼Œæœ€ç»ˆè¿˜æ˜¯é€šè¿‡findViewByIdä»source(è¿™é‡Œæ˜¯MainActivityçš„é¡¶å±‚View)è·å–åˆ°äº†æ§ä»¶ï¼Œç„¶åå°†å…¶è¿”å›ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">findRequiredViewAsType</span><span class="o">(</span><span class="nc">View</span> <span class="n">source</span><span class="o">,</span> <span class="nd">@IdRes</span> <span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">who</span><span class="o">,</span>
                                           <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">cls</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">findRequiredView</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">who</span><span class="o">);</span>
  <span class="k">return</span> <span class="nf">castView</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">who</span><span class="o">,</span> <span class="n">cls</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="nc">View</span> <span class="nf">findRequiredView</span><span class="o">(</span><span class="nc">View</span> <span class="n">source</span><span class="o">,</span> <span class="nd">@IdRes</span> <span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">who</span><span class="o">)</span> <span class="o">{</span>
  	<span class="c1">//å¯ä»¥çœ‹åˆ°æœ€ç»ˆè¿˜æ˜¯é€šè¿‡findViewByIdä»sourceä¸­æ‰¾åˆ°View</span>
    <span class="nc">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">view</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">view</span><span class="o">;</span>
    <span class="o">}</span>
   <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å†å›åˆ°MainActivity_ViewBindingçš„æ„é€ æ–¹æ³•ä¸­ï¼Œç”±äºåœ¨ä¾‹å­ä¸­æˆ‘ä»¬åœ¨å±æ€§åä¸ºbtçš„æŒ‰é’®è®¾ç½®äº†BindViewçš„æ³¨è§£ï¼Œæ‰€ä»¥è¿™é‡Œå°†æ‰¾åˆ°çš„æ§ä»¶èµ‹å€¼ç»™MainActivityçš„btå±æ€§ï¼Œè¿™é‡Œç”±äºæ˜¯ç›´æ¥èµ‹å€¼ï¼Œå› æ­¤è¢«æ³¨è§£ä¿®é¥°çš„å±æ€§è®¿é—®æƒé™ä¸èƒ½ä¸ºprivateã€‚</p>

<p>ç”±äºåœ¨ä¾‹å­ä¸­æˆ‘ä»¬è¿˜ç»™R.id.btçš„æ§ä»¶è®¾ç½®äº†ç‚¹å‡»äº‹ä»¶çš„å›è°ƒæ–¹æ³•ï¼Œæ‰€ä»¥è¿™è¾¹æ‰¾åˆ°R.id.btçš„æ§ä»¶ä¹‹åï¼Œè¿˜éœ€ä¸ºå…¶è®¾ç½®ç‚¹å‡»äº‹ä»¶ï¼Œå¹¶åœ¨å›è°ƒæ–¹æ³•ä¸­å›è°ƒMainActivityçš„onClickæ–¹æ³•ã€‚å› æ­¤btå¯¹åº”çš„æ§ä»¶è¢«ç‚¹å‡»ï¼ŒMainActivityçš„onClickä¼šè¢«å›è°ƒã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">MainActivity_ViewBinding</span><span class="o">(</span><span class="kd">final</span> <span class="nc">MainActivity</span> <span class="n">target</span><span class="o">,</span> <span class="nc">View</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
 		<span class="o">...</span>
    <span class="c1">//è·å–idä¸ºR.id.btçš„View</span>
    <span class="n">view</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">findRequiredView</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">bt</span><span class="o">,</span> <span class="s">"field 'bt' and method 'onClick'"</span><span class="o">);</span>
  	<span class="n">target</span><span class="o">.</span><span class="na">bt</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">castView</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">bt</span><span class="o">,</span> <span class="s">"field 'bt'"</span><span class="o">,</span> <span class="nc">Button</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">view7f070042</span> <span class="o">=</span> <span class="n">view</span><span class="o">;</span>
    <span class="c1">//ä¸ºR.id.btçš„æ§ä»¶è®¾ç½®ç›‘å¬å™¨</span>
    <span class="n">view</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">DebouncingOnClickListener</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">p0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">target</span><span class="o">.</span><span class="na">onClick</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æœ€åå†è®²ä¸‹unbindè¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ç”¨äºç§»é™¤ä¹‹å‰ç»‘å®šæ§ä»¶æˆ–è€…ç›‘å¬å™¨çš„å¼•ç”¨ï¼Œåœ¨Activityé”€æ¯å‰è°ƒç”¨ï¼Œç”¨äºåŠæ—¶å›æ”¶ä¸å¿…è¦çš„å†…å­˜ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="nd">@CallSuper</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">unbind</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">MainActivity</span> <span class="n">target</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">target</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span><span class="s">"Bindings already cleared."</span><span class="o">);</span>
  <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

  <span class="c1">// ç§»é™¤è¢«BindViewä¿®é¥°çš„Viewæ§ä»¶çš„å¼•ç”¨</span>
  <span class="n">target</span><span class="o">.</span><span class="na">cl</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="n">target</span><span class="o">.</span><span class="na">bt</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="c1">// ç§»é™¤ç›‘å¬å™¨</span>
  <span class="n">view7f070042</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
  <span class="n">view7f070042</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å¥½äº†ï¼ŒMainActivity_ViewBindingç±»ç®—æ˜¯è®²è§£å®Œäº†ï¼Œè¿™é‡Œåšä¸€ä¸ªå°ç»“</p>

<ul>
  <li>Activityæˆ–è€…Fragmentä¸­æœ‰ä½¿ç”¨BindViewç­‰æ³¨è§£ï¼Œåœ¨é¡¹ç›®ç¼–è¯‘æ—¶ï¼ŒButterKnifeä¼šåœ¨åŒçº§åŒ…ç›®å½•ä¸‹ç”Ÿæˆ[ç±»å‹]_ViewBindingç±»(ä¸€ä¸ªç±»å¯¹åº”ä¸€ä¸ªViewBindingç±»)</li>
  <li>åœ¨ç”Ÿæˆçš„ç±»çš„æ„é€ æ–¹æ³•ä¸­ä¼šå¯¹ç›®æ ‡ç±»ä¸­æ‰€æœ‰è¢«æ³¨è§£ä¿®é¥°çš„å±æ€§è¿›è¡Œå€¼çš„æ³¨å…¥ï¼Œè‹¥å­˜åœ¨ç›‘å¬å™¨ç›¸å…³çš„æ³¨è§£ï¼Œåˆ™åŒæ—¶ä¸ºæ§ä»¶åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨ï¼Œå¹¶å›è°ƒç›®æ ‡ç±»å¯¹åº”çš„æ–¹æ³•</li>
</ul>

<h2 id="32-butterknifebind">3.2 ButterKnife.bind</h2>

<p>çœ‹åˆ°è¿™ï¼Œç›¸ä¿¡å¤§å®¶å¿ƒé‡Œéƒ½æœ‰ç–‘é—®ï¼Œè™½ç„¶ç”Ÿæˆäº†è¿™æ ·ä¸€ä¸ªç±»ï¼Œå®ƒåœ¨æ„é€ æ–¹æ³•ä¸­å®Œæˆäº†å€¼çš„æ³¨å…¥ï¼Œä½†æ˜¯ä¹Ÿæ²¡çœ‹è§ButterKnifeè°ƒç”¨å•Šã€‚</p>

<p>æˆ‘ä»¬å†å›åˆ°ä¾‹å­ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯è¿˜æ¼äº†ä»€ä¹ˆä¸œè¥¿ã€‚å¯¹çš„ï¼Œæƒ³å¿…ä½ ä¹Ÿå‘ç°äº†ï¼Œæˆ‘ä»¬åœ¨onCreateæ–¹æ³•ä¸­å°†MainActivityå¯¹è±¡æ³¨å…¥åˆ°äº†ButterKnifeä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™é‡Œåšäº†ä»€ä¹ˆæ“ä½œã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
		<span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
        <span class="n">mUnbinder</span> <span class="o">=</span> <span class="nc">ButterKnife</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ButterKnifeè¿™ä¸ªç±»çš„ä»£ç ä¹Ÿæ¯”è¾ƒå°‘</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ButterKnife</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nf">ButterKnife</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">AssertionError</span><span class="o">(</span><span class="s">"No instances."</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TAG</span> <span class="o">=</span> <span class="s">"ButterKnife"</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">debug</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

  <span class="c1">// ç”¨äºç¼“å­˜_ViewBindingç±»çš„æ„é€ æ–¹æ³•ï¼Œé¿å…æ¯æ¬¡é€šè¿‡åå°„å»è·å–</span>
  <span class="nd">@VisibleForTesting</span>
  <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;&gt;</span> <span class="no">BINDINGS</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>

  <span class="cm">/** Control whether debug logging is enabled. */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setDebug</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">debug</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ButterKnife</span><span class="o">.</span><span class="na">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="o">;</span>
  <span class="o">}</span>


  <span class="c1">// Activityæ³¨å…¥</span>
  <span class="nd">@NonNull</span> <span class="nd">@UiThread</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Unbinder</span> <span class="nf">bind</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Activity</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">View</span> <span class="n">sourceView</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getWindow</span><span class="o">().</span><span class="na">getDecorView</span><span class="o">();</span>
    <span class="k">return</span> <span class="nf">bind</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">sourceView</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// Viewæ³¨å…¥ï¼Œä¾‹å¦‚è‡ªå®šä¹‰Viewä¸­ä½¿ç”¨æ³¨è§£</span>
  <span class="nd">@NonNull</span> <span class="nd">@UiThread</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Unbinder</span> <span class="nf">bind</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">View</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">bind</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
  <span class="o">}</span>


  <span class="c1">// å¯¹è¯æ¡†æ³¨å…¥</span>
  <span class="nd">@NonNull</span> <span class="nd">@UiThread</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Unbinder</span> <span class="nf">bind</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Dialog</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">View</span> <span class="n">sourceView</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getWindow</span><span class="o">().</span><span class="na">getDecorView</span><span class="o">();</span>
    <span class="k">return</span> <span class="nf">bind</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">sourceView</span><span class="o">);</span>
  <span class="o">}</span>


  <span class="c1">// Activityæ³¨å…¥</span>
  <span class="nd">@NonNull</span> <span class="nd">@UiThread</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Unbinder</span> <span class="nf">bind</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">Activity</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">View</span> <span class="n">sourceView</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">getWindow</span><span class="o">().</span><span class="na">getDecorView</span><span class="o">();</span>
    <span class="k">return</span> <span class="nf">bind</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">sourceView</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// å¯¹è¯æ¡†æ³¨å…¥</span>
  <span class="nd">@NonNull</span> <span class="nd">@UiThread</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Unbinder</span> <span class="nf">bind</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">Dialog</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">View</span> <span class="n">sourceView</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">getWindow</span><span class="o">().</span><span class="na">getDecorView</span><span class="o">();</span>
    <span class="k">return</span> <span class="nf">bind</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">sourceView</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@NonNull</span> <span class="nd">@UiThread</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Unbinder</span> <span class="nf">bind</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">View</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
    <span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">findBindingConstructorForClass</span><span class="o">(</span><span class="n">targetClass</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">constructor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Unbinder</span><span class="o">.</span><span class="na">EMPTY</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Unable to create binding instance."</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// å¯»æ‰¾_ViewBindingç±»çš„æ„é€ æ–¹æ³•</span>
  <span class="nd">@Nullable</span> <span class="nd">@CheckResult</span> <span class="nd">@UiThread</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;</span> <span class="nf">findBindingConstructorForClass</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cls</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ç¼“å­˜ä¸­å­˜åœ¨è¯¥æ„é€ æ–¹æ³•ç›´æ¥è¿”å›</span>
    <span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;</span> <span class="n">bindingCtor</span> <span class="o">=</span> <span class="no">BINDINGS</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cls</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">bindingCtor</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="no">BINDINGS</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">cls</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">bindingCtor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// è¿‡æ»¤ç³»ç»Ÿç±»</span>
    <span class="nc">String</span> <span class="n">clsName</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">clsName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"android."</span><span class="o">)</span> <span class="o">||</span> <span class="n">clsName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"java."</span><span class="o">)</span>
        <span class="o">||</span> <span class="n">clsName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"androidx."</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// åŠ è½½ViewBindingç±»åˆ°å†…å­˜</span>
      <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">bindingClass</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="n">clsName</span> <span class="o">+</span> <span class="s">"_ViewBinding"</span><span class="o">);</span>
      <span class="c1">// è·å–ViewBindingç±»çš„æ„é€ æ–¹æ³•</span>
      <span class="n">bindingCtor</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;)</span> <span class="n">bindingClass</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="n">cls</span><span class="o">,</span> <span class="nc">View</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Unable to find binding constructor for "</span> <span class="o">+</span> <span class="n">clsName</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// è·å–æˆåŠŸåæŠŠç‹—æ‚æ–¹æ³•è¿›è¡Œç¼“å­˜</span>
    <span class="no">BINDINGS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cls</span><span class="o">,</span> <span class="n">bindingCtor</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">bindingCtor</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™é‡Œç»§ç»­ä½¿ç”¨ä¸Šè¿°çš„ä¾‹å­è¿›è¡Œè®²è§£</p>

<p>åœ¨MainActivityçš„onCreateä¸­è°ƒç”¨äº†bindæ–¹æ³•ï¼Œå°†Activityæ³¨å…¥åˆ°ButterKnifeï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨äº†ä¸¤ä¸ªå‚æ•°çš„bindæ–¹æ³•ï¼Œè¿™è¾¹targetå°±æ˜¯MainActivityå¯¹è±¡ï¼Œsourceä¸ºMainActivityçš„DecorViewã€‚</p>

<p>å¯ä»¥çœ‹åˆ°åœ¨bindæ–¹æ³•ä¸­æ ¹æ®targetClass(è¿™é‡Œæ˜¯æŒ‡MainActivity)å»å¯»æ‰¾_ViewBindingç±»çš„æ„é€ æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Activityæ³¨å…¥</span>
<span class="nd">@NonNull</span> <span class="nd">@UiThread</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Unbinder</span> <span class="nf">bind</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Activity</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// å¾—åˆ°é¡¶å±‚å®¹å™¨DecorView</span>
  <span class="nc">View</span> <span class="n">sourceView</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getWindow</span><span class="o">().</span><span class="na">getDecorView</span><span class="o">();</span>
  <span class="k">return</span> <span class="nf">bind</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">sourceView</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@NonNull</span> <span class="nd">@UiThread</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Unbinder</span> <span class="nf">bind</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">View</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
  <span class="c1">// å¯»æ‰¾_ViewBindingçš„æ„é€ æ–¹æ³•</span>
  <span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">findBindingConstructorForClass</span><span class="o">(</span><span class="n">targetClass</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">constructor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Unbinder</span><span class="o">.</span><span class="na">EMPTY</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Unable to create binding instance."</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ¥ä¸‹æ¥æ¥çœ‹çœ‹findBindingConstructorForClassæ–¹æ³•çš„å®ç°</p>

<ul>
  <li>é¦–å…ˆæ ¹æ®targetClasså»ç¼“å­˜ä¸­å¯»æ‰¾æ˜¯å¦å­˜åœ¨targetClasså¯¹ç”¨çš„_ViewBindingç±»çš„æ„é€ æ–¹æ³•ï¼Œç¼“å­˜ä¸­å­˜åœ¨å°±ç›´æ¥è¿”å›</li>
  <li>ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè¿‡æ»¤ä¸€äº›ç³»ç»Ÿçš„ç±»åï¼Œæ ¹æ®targetClassçš„å¾—åˆ°å¯¹åº” _ViewBindingçš„å…¨ç±»åï¼Œå°†è¯¥_ViewBindingç±»é€šè¿‡ClassLoaderåŠ è½½åˆ°å†…å­˜ï¼Œç„¶åé€šè¿‡Classå»è·å–ç±»å¯¹åº”çš„æ„é€ æ–¹æ³•</li>
  <li>è·å–åˆ°æ„é€ æ–¹æ³•ä¹‹åå°†æ„é€ æ–¹æ³•åŠ å…¥åˆ°ç¼“å­˜Mapä¸­ï¼Œç„¶åè¿”å›è¯¥æ„é€ æ–¹æ³•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å¯»æ‰¾_ViewBindingç±»çš„æ„é€ æ–¹æ³•</span>
  <span class="nd">@Nullable</span> <span class="nd">@CheckResult</span> <span class="nd">@UiThread</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;</span> <span class="nf">findBindingConstructorForClass</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cls</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ç¼“å­˜ä¸­å­˜åœ¨è¯¥æ„é€ æ–¹æ³•ç›´æ¥è¿”å›</span>
    <span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;</span> <span class="n">bindingCtor</span> <span class="o">=</span> <span class="no">BINDINGS</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cls</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">bindingCtor</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="no">BINDINGS</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">cls</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">bindingCtor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// è¿‡æ»¤ç³»ç»Ÿç±»</span>
    <span class="nc">String</span> <span class="n">clsName</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">clsName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"android."</span><span class="o">)</span> <span class="o">||</span> <span class="n">clsName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"java."</span><span class="o">)</span>
        <span class="o">||</span> <span class="n">clsName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"androidx."</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// åŠ è½½ViewBindingç±»åˆ°å†…å­˜</span>
      <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">bindingClass</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="n">clsName</span> <span class="o">+</span> <span class="s">"_ViewBinding"</span><span class="o">);</span>
      <span class="c1">// è·å–ViewBindingç±»çš„æ„é€ æ–¹æ³•</span>
      <span class="n">bindingCtor</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;)</span> <span class="n">bindingClass</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="n">cls</span><span class="o">,</span> <span class="nc">View</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Unable to find binding constructor for "</span> <span class="o">+</span> <span class="n">clsName</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// è·å–æˆåŠŸåæŠŠæ„é€ æ–¹æ³•è¿›è¡Œç¼“å­˜</span>
    <span class="no">BINDINGS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cls</span><span class="o">,</span> <span class="n">bindingCtor</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">bindingCtor</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>â€‹		ç°åœ¨å†å›åˆ°bindæ–¹æ³•ä¸­ï¼Œé€šè¿‡findBindingConstructorForClassæ–¹æ³•æ‹¿åˆ°äº†ViewBindingç±»çš„æ„é€ æ–¹æ³•ï¼Œç„¶åé€šè¿‡æ„é€ æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªViewBindingçš„å®ä¾‹(è¿™é‡Œæ˜¯MainActivity_ViewBindingç±»çš„å®ä¾‹)ã€‚</p>

<p>â€‹		æˆ‘ä»¬åœ¨å‰ä¸€ä¸ªå°ç»“ä¸­å·²ç»æåˆ°ï¼ŒMainActivityä¸­çš„å€¼æ³¨å…¥å’Œç›‘å¬å™¨çš„ç»‘å®šæ˜¯åœ¨MainActivity_ViewBindingçš„æ„é€ æ–¹æ³•ä¸­å®Œæˆçš„ï¼Œè€Œè¿™ä¸ªMainActivity_ViewBindingå®ä¾‹å°±æ˜¯åœ¨ButterKnife.bindæ–¹æ³•è¢«è°ƒç”¨æ—¶åˆ›å»ºçš„ï¼Œæ­¤æ—¶æ•´ä¸ªä¾èµ–æ³¨å…¥æµç¨‹å°±å·²ç»å®Œæˆäº†ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Unbinder</span> <span class="nf">bind</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">View</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
    <span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">findBindingConstructorForClass</span><span class="o">(</span><span class="n">targetClass</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">constructor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Unbinder</span><span class="o">.</span><span class="na">EMPTY</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Unable to create binding instance."</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>å°ç»“ï¼š é€šè¿‡ButterKnifeçš„bindæ–¹æ³•ç”Ÿæˆäº†ä¸€ä¸ªViewBindingç±»çš„å®ä¾‹ï¼Œç„¶ååœ¨ViewBindingç±»ä¸­è¿›è¡Œäº†è¢«æ³¨è§£ä¿®é¥°å±æ€§å€¼çš„æ³¨å…¥ä»¥åŠäº‹ä»¶ç›‘å¬å›è°ƒæ–¹æ³•çš„ç»‘å®šã€‚</p>

<h2 id="33-æ³¨è§£å¤„ç†å™¨">3.3 æ³¨è§£å¤„ç†å™¨</h2>

<p>â€‹	æ˜¯ä¸æ˜¯æç„¶å¤§æ‚Ÿï¼ŒåŸæ¥ButterKnifeå¸®æˆ‘ä»¬åšäº†è¿™äº›äº‹æƒ…å•Šï¼Œå…¶å®ButterKnifeå¸®æˆ‘ä»¬åšçš„äº‹æƒ…è¿œä¸æ­¢è¿™äº›ï¼Œå‰é¢æˆ‘ä»¬æåˆ°åªè¦ä½ åœ¨Activityæˆ–è€…Fragmentç­‰åœ°æ–¹æ­£ç¡®çš„ä½¿ç”¨äº†ButterKnifeçš„æ³¨è§£ï¼Œåœ¨ç¼–è¯‘æ—¶ButterKnifeå°±ä¼šä¸ºè¿™äº›ä½¿ç”¨äº†æ³¨è§£çš„Activityæˆ–è€…Fragmentç”Ÿæˆå¯¹åº”çš„ViewBindingç±»ï¼Œé‚£ä¹ˆè¿™ç§æ“ä½œæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Œè¿™å°±è¦ç”¨åˆ°APT(Annotation Processing Tool)æŠ€æœ¯äº†ã€‚</p>

<p>â€‹	ä¸äº†è§£APTçš„åŒå­¦å¯ä»¥æˆ³è¿™é‡Œ <a href="https://partingsoul.github.io/2019/11/26/APTæŠ€æœ¯/">APTå…¥é—¨</a></p>

<hr />

<h3 id="331-æ•´ä½“æµç¨‹">3.3.1 æ•´ä½“æµç¨‹</h3>

<p>â€‹	æ³¨è§£å¤„ç†å™¨åœ¨ç¼–è¯‘æ—¶å¯ä»¥è·å–åˆ°æ³¨è§£çš„ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚è¢«æ³¨è§£ä¿®é¥°çš„ç±»å…ƒç´ ï¼Œå­—æ®µå…ƒç´ ç­‰ç­‰ï¼Œå®ƒåœ¨ButterKnifeä¸­çš„ä½œç”¨å°±æ˜¯é€šè¿‡æ ¹æ®æ³¨è§£çš„ç›¸å…³ä¿¡æ¯ï¼Œåœ¨äº‹å…ˆå®šä¹‰å¥½çš„æ¨¡æ¿ç±»ä¸­å¡«å……ä»£ç ï¼Œæœ€ç»ˆå°†è¿™ä¸ªç±»ä¿¡æ¯è¾“å‡ºåˆ°æ–‡ä»¶ä¸­ã€‚</p>

<p>â€‹	é¦–å…ˆçœ‹ä¸€ä¸‹æ³¨è§£å¤„ç†çš„æ ¸å¿ƒç±» <strong>ButterKnifeProcessor</strong>ï¼Œè¯¥ç±»åœ¨ç¼–è¯‘æ—¶ä¼šè¢«ç³»ç»Ÿæ‰«æåˆ°ï¼Œä»è€Œæ‰§è¡Œæ³¨è§£å¤„ç†çš„ä»£ç ã€‚</p>

<p>æ”¯æŒçš„æ³¨è§£ç±»å‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//æ”¯æŒçš„ç›‘å¬å™¨æ³¨è§£ç±»å‹</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;&gt;</span> <span class="no">LISTENERS</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="c1">//</span>
  <span class="nc">OnCheckedChanged</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">//</span>
  <span class="nc">OnClick</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">//</span>
  <span class="nc">OnEditorAction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">//</span>
  <span class="nc">OnFocusChange</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">//</span>
  <span class="nc">OnItemClick</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">//</span>
  <span class="nc">OnItemLongClick</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">//</span>
  <span class="nc">OnItemSelected</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">//</span>
  <span class="nc">OnLongClick</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">//</span>
  <span class="nc">OnPageChange</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">//</span>
  <span class="nc">OnTextChanged</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">//</span>
  <span class="nc">OnTouch</span><span class="o">.</span><span class="na">class</span> <span class="c1">//</span>
<span class="o">);</span>

<span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;&gt;</span> <span class="nf">getSupportedAnnotations</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;&gt;</span> <span class="n">annotations</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindAnim</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindArray</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindBitmap</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindBool</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindColor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindDimen</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindDrawable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindFloat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindFont</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindInt</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindString</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">BindViews</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">annotations</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="no">LISTENERS</span><span class="o">);</span>
  <span class="k">return</span> <span class="n">annotations</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getSupportedAnnotationTypes</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">types</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">annotation</span> <span class="o">:</span> <span class="n">getSupportedAnnotations</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">types</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">types</span><span class="o">;</span>
<span class="o">}</span>

</code></pre></div></div>

<p>processæ–¹æ³•ä¸ºæ³¨è§£å¤„ç†çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦åšäº†ä¸¤ä¸ªäº‹æƒ…</p>

<ul>
  <li>å¯»æ‰¾å¹¶ä¸”è§£æè¢«æ³¨è§£ä¿®é¥°çš„å…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªç±»å…ƒç´ ä¸å®ƒå¯¹åº”Viewbindingç±»ä¿¡æ¯çš„ä¸€ä¸ªMap</li>
  <li>éå†æ‰€æœ‰çš„ViewBindingç±»ä¿¡æ¯ç±»ï¼Œä¸ºæ¯ä¸ªè¢«æ³¨è§£ä¿®é¥°çš„ç±»å…ƒç´ åˆ›å»ºä¸€ä¸ªViewBindingç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">process</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">elements</span><span class="o">,</span> <span class="nc">RoundEnvironment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//å¯»æ‰¾å¹¶ä¸”è§£æè¢«æ³¨è§£ä¿®é¥°çš„å…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªç±»å…ƒç´ ä¸å®ƒå¯¹åº”viewbindingç±»ä¿¡æ¯çš„ä¸€ä¸ªMap</span>
  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">&gt;</span> <span class="n">bindingMap</span> <span class="o">=</span> <span class="n">findAndParseTargets</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>

  <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">bindingMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">TypeElement</span> <span class="n">typeElement</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
    <span class="nc">BindingSet</span> <span class="n">binding</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
    <span class="c1">//ç”Ÿæˆè¢«æ³¨è§£ä¿®é¥°ç±»çš„viewbindingç±»Javaä»£ç </span>
    <span class="nc">JavaFile</span> <span class="n">javaFile</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">brewJava</span><span class="o">(</span><span class="n">sdk</span><span class="o">,</span> <span class="n">debuggable</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">javaFile</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">filer</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="n">typeElement</span><span class="o">,</span> <span class="s">"Unable to write binding for type %s: %s"</span><span class="o">,</span> <span class="n">typeElement</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="332-æ³¨è§£ç¼–è¯‘å™¨é¡¹ç›®ç»“æ„">3.3.2 æ³¨è§£ç¼–è¯‘å™¨é¡¹ç›®ç»“æ„</h3>

<p>åœ¨åˆ†æç»†èŠ‚å‰ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹ButterKnifeæ³¨è§£ç¼–è¯‘å™¨çš„é¡¹ç›®ç»“æ„</p>

<p><img src="http://qagey3wv5.bkt.clouddn.com//butterknife-compiler.png" alt="butterknife-compiler" /></p>

<p>æ¯ä¸ªç±»æˆ–æ¥å£çš„ä½œç”¨ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ç±»/æ¥å£</th>
      <th style="text-align: left">ä½œç”¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">BindingSet</td>
      <td style="text-align: left">ViewBindingç±»å†…éƒ¨æ‰€æœ‰çš„ä¿¡æ¯(å±æ€§ï¼Œæ–¹æ³•ç­‰)ï¼Œä¸€ä¸ªç±»å¯¹åº”ä¸€ä¸ªBindingSetï¼ŒåŒæ—¶å…·æœ‰ç”Ÿæˆæ¨¡æ¿ä»£ç çš„èƒ½åŠ›</td>
    </tr>
    <tr>
      <td style="text-align: left">ButterKnifeProcessor</td>
      <td style="text-align: left">æ³¨è§£å¤„ç†å™¨</td>
    </tr>
    <tr>
      <td style="text-align: left">FieldAnimationBinding</td>
      <td style="text-align: left">è¢«æ³¨è§£ä¿®é¥°çš„åŠ¨ç”»å±æ€§ä¿¡æ¯</td>
    </tr>
    <tr>
      <td style="text-align: left">FieldCollectionViewBinding</td>
      <td style="text-align: left">è¢«BindViewsä¿®é¥°çš„æ§ä»¶ç»„å±æ€§ä¿¡æ¯</td>
    </tr>
    <tr>
      <td style="text-align: left">FieldDrawableBinding</td>
      <td style="text-align: left">è¢«æ³¨è§£ä¿®é¥°çš„Drawableå±æ€§ä¿¡æ¯(drawbableå¯¹åº”çš„idï¼Œå±æ€§çš„åç§°ç­‰)</td>
    </tr>
    <tr>
      <td style="text-align: left">FieldResourceBinding</td>
      <td style="text-align: left">è¢«æ³¨è§£ä¿®é¥°çš„èµ„æºå±æ€§ä¿¡æ¯(è¿™é‡Œçš„èµ„æºåŒ…æ‹¬bitmap,dimen,color,stringç­‰)</td>
    </tr>
    <tr>
      <td style="text-align: left">FieldTypefaceBinding</td>
      <td style="text-align: left">è¢«æ³¨è§£ä¿®é¥°çš„å­—ä½“å±æ€§çš„ä¿¡æ¯ï¼ˆå±æ€§çš„åå­—ï¼Œå­—ä½“çš„idï¼Œå­—ä½“çš„é£æ ¼ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: left">FieldViewBinding</td>
      <td style="text-align: left">è¢«æ³¨è§£ä¿®é¥°çš„æ§ä»¶å±æ€§çš„ä¿¡æ¯(æ§ä»¶åã€ç±»å‹ã€æ˜¯å¦å¿…é¡»)</td>
    </tr>
    <tr>
      <td style="text-align: left">Id</td>
      <td style="text-align: left">èµ„æºidä¿¡æ¯å°è£…ï¼ŒåŒ…æ‹¬idçš„å€¼ã€idçš„ä»£ç </td>
    </tr>
    <tr>
      <td style="text-align: left">MemberViewBinding</td>
      <td style="text-align: left">è¢«æ³¨è§£ä¿®é¥°æˆå‘˜ä¿¡æ¯æ¥å£(æˆå‘˜åŒ…æ‹¬å±æ€§å’Œæ–¹æ³•)</td>
    </tr>
    <tr>
      <td style="text-align: left">MethodViewBinding</td>
      <td style="text-align: left">è¢«æ³¨è§£ä¿®é¥°æ–¹æ³•çš„ä¿¡æ¯(æ–¹æ³•åã€æ–¹æ³•çš„å‚æ•°ã€è¿”å›å€¼)</td>
    </tr>
    <tr>
      <td style="text-align: left">Parameter</td>
      <td style="text-align: left">ç›‘å¬å™¨æ–¹æ³•å½¢å‚çš„å°è£…ï¼ˆå½¢å‚çš„ç±»å‹ï¼Œå½¢å‚çš„ä½ç½®ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: left">ResourceBinding</td>
      <td style="text-align: left">èµ„æºç»‘å®šä¿¡æ¯æ¥å£</td>
    </tr>
    <tr>
      <td style="text-align: left">ViewBinding</td>
      <td style="text-align: left">æ§ä»¶ç»‘å®šä¿¡æ¯ï¼Œå­˜å‚¨äº†è¢«BindViewä¿®é¥°æ§ä»¶çš„ä¿¡æ¯ä»¥åŠè¯¥æ§ä»¶çš„äº‹ä»¶ç›‘å¬ä¿¡æ¯ï¼Œä¸€ä¸ªViewå¯¹åº”ä¸€ä¸ªViewBinding</td>
    </tr>
  </tbody>
</table>

<p>ä»ä¸Šå¯çŸ¥ ButterKnifeæ³¨è§£ç¼–è¯‘å™¨ä¸­çš„ç±»å¯ä»¥åˆ†ä¸ºä¸‰ç±»</p>

<ul>
  <li>
    <p>æ³¨è§£å¤„ç†å™¨</p>
  </li>
  <li>ç”¨äºä¿å­˜<strong>è¢«æ³¨è§£ä¿®é¥°å±æ€§æˆ–è€…æ–¹æ³•çš„ä¿¡æ¯</strong>æè¿°ç±»</li>
  <li>BindingSet å­˜å‚¨äº†ä¸€ä¸ªViewBindingç±»æ‰€æœ‰å…ƒç´ ä¿¡æ¯ï¼Œå¹¶ä¸”æä¾›ç”Ÿæˆæ¨¡æ¿ä»£ç çš„èƒ½åŠ›</li>
</ul>

<h3 id="333-processæ–¹æ³•">3.3.3 processæ–¹æ³•</h3>

<h4 id="1-è§£ææ³¨è§£è·å¾—viewbindingç±»ä¿¡æ¯é›†åˆ">1. è§£ææ³¨è§£è·å¾—ViewBindingç±»ä¿¡æ¯é›†åˆ</h4>

<p>æˆ‘ä»¬ç°åœ¨å¼€å§‹åˆ†æprocessæ–¹æ³•çš„ç»†èŠ‚ï¼Œåœ¨processä¸­é¦–å…ˆè°ƒç”¨äº†findAndParseTargetsæ–¹æ³•ï¼Œå»è§£ææ‰€æœ‰è¢«ButterKnifeä¿®é¥°çš„æ³¨è§£ï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªMapï¼ŒMapçš„Keyå­˜å‚¨è¢«ButterKnifeæ³¨è§£ä¿®é¥°æˆå‘˜çš„ç±»ï¼Œvalueä¿å­˜äº†ViewBindingç±»ç›¸å…³ä¿¡æ¯ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">//å¯»æ‰¾å¹¶ä¸”è§£æè¢«æ³¨è§£ä¿®é¥°çš„å…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªç±»å…ƒç´ ä¸å®ƒå¯¹åº”viewbindingç±»ä¿¡æ¯çš„ä¸€ä¸ªMap</span>
  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">&gt;</span> <span class="n">bindingMap</span> <span class="o">=</span> <span class="n">findAndParseTargets</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
</code></pre></div></div>

<p>è¿›å…¥findAndParseTargetsæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>

<ul>
  <li>è§£æå„ç§ButterKnifeæ³¨è§£</li>
  <li>ä¸ºæ¯ä¸€ä¸ªè¢«æ³¨è§£ä¿®é¥°æˆå‘˜å…ƒç´ çš„çˆ¶å…ƒç´ (ç±»å…ƒç´ )ç”Ÿæˆå¯¹åº”çš„ViewBindingç±»ç»“æ„ä¿¡æ¯(BindingSet)</li>
</ul>

<p>è¿™è¾¹å…ˆä»è§£ææ³¨è§£å¼€å§‹ï¼Œä»¥è§£æBindViewæ³¨è§£ä¸ºä¾‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">&gt;</span> <span class="nf">findAndParseTargets</span><span class="o">(</span><span class="nc">RoundEnvironment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">builderMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="c1">// ç”¨äºä¿å­˜è¢«æ³¨è§£ä¿®é¥°æˆå‘˜å…ƒç´ çš„çˆ¶å…ƒç´ (è¿™é‡Œæ˜¯ç±»å…ƒç´ )ï¼ŒButterKnifeæ³¨è§£æ˜¯ç”¨äºä¿®é¥°å­—æ®µæˆ–è€…æ–¹æ³•çš„</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">erasedTargetNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>


    <span class="c1">// ... çœç•¥å¤„ç†å…¶ä»–å¤„ç†æ³¨è§£çš„ä»£ç </span>

    <span class="c1">// éå†æ‰€æœ‰è¢«BindViewä¿®é¥°çš„å…ƒç´ </span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Element</span> <span class="n">element</span> <span class="o">:</span> <span class="n">env</span><span class="o">.</span><span class="na">getElementsAnnotatedWith</span><span class="o">(</span><span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
          	<span class="c1">// è§£æè¯¥å…ƒç´ ä»¥åŠæ³¨è§£</span>
            <span class="n">parseBindView</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">builderMap</span><span class="o">,</span> <span class="n">erasedTargetNames</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logParsingError</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="o">...</span>
    <span class="k">return</span> <span class="n">bindingMap</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>parseBindViewæ–¹æ³•ä¸»è¦æ˜¯ç”¨äºè§£æBindViewæ³¨è§£ï¼Œå¾—åˆ°è¢«æ³¨è§£ä¿®é¥°å±æ€§çš„ä¿¡æ¯ï¼Œç„¶åå°†å…¶ä¿å­˜èµ·æ¥</p>

<p>æ‰§è¡Œæµç¨‹ï¼š</p>

<ol>
  <li>
    <p>æ£€æŸ¥æ³¨è§£ä¿®é¥°çš„åˆæ³•æ€§(åŒ…æ‹¬è¢«æ³¨è§£ä¿®é¥°å±æ€§çš„è®¿é—®æƒé™ä»¥åŠæ³¨è§£ä¿®é¥°çš„ç±»åˆæ³•æ€§)</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseBindView</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">builderMap</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">erasedTargetNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//å¾—åˆ°å½“å‰å­—æ®µå…ƒç´ çš„çˆ¶å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ç±»å…ƒç´ </span>
        <span class="nc">TypeElement</span> <span class="n">enclosingElement</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeElement</span><span class="o">)</span> <span class="n">element</span><span class="o">.</span><span class="na">getEnclosingElement</span><span class="o">();</span>

        <span class="c1">//åˆ¤æ–­å…ƒç´ çš„è®¿é—®æƒé™çš„åˆæ³•æ€§ä»¥åŠæ˜¯å¦åˆ¤æ–­åœ¨ç³»ç»Ÿçš„apiç±»ä¸­ä½¿ç”¨äº†ButterKnifeæ³¨è§£</span>
        <span class="kt">boolean</span> <span class="n">hasError</span> <span class="o">=</span> <span class="n">isInaccessibleViaGeneratedCode</span><span class="o">(</span><span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"fields"</span><span class="o">,</span> <span class="n">element</span><span class="o">)</span>
                <span class="o">||</span> <span class="n">isBindingInWrongPackage</span><span class="o">(</span><span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseBindView</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">builderMap</span><span class="o">,</span>
                               <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">erasedTargetNames</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// å¦‚æœæ³¨è§£ä¿®é¥°çš„æ˜¯æ³›å‹</span>
        <span class="nc">TypeMirror</span> <span class="n">elementType</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">asType</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">elementType</span><span class="o">.</span><span class="na">getKind</span><span class="o">()</span> <span class="o">==</span> <span class="nc">TypeKind</span><span class="o">.</span><span class="na">TYPEVAR</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/**
             *  æ‰¾åˆ°æ³›å‹ç±»å‹çš„ä¸Šç•Œ ä¾‹å¦‚
             * @BindView(R.id.xx)
             * T view;
             * å…¶ä¸­Tçš„ç±»å‹ä¸º ? extend View
             */</span>
            <span class="nc">TypeVariable</span> <span class="n">typeVariable</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeVariable</span><span class="o">)</span> <span class="n">elementType</span><span class="o">;</span>
            <span class="n">elementType</span> <span class="o">=</span> <span class="n">typeVariable</span><span class="o">.</span><span class="na">getUpperBound</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// å¾—åˆ°ç±»å…ƒç´ çš„å…¨å</span>
        <span class="nc">Name</span> <span class="n">qualifiedName</span> <span class="o">=</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">();</span>
        <span class="c1">// å¾—åˆ°å±æ€§çš„åå­—</span>
        <span class="nc">Name</span> <span class="n">simpleName</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isSubtypeOfType</span><span class="o">(</span><span class="n">elementType</span><span class="o">,</span> <span class="no">VIEW_TYPE</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isInterface</span><span class="o">(</span><span class="n">elementType</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// è‹¥å½“å‰ç±»ä¸æ˜¯Viewç±»çš„å­ç±»å¹¶ä¸”ç±»å‹å…ƒç´ ä¸æ˜¯æ¥å£</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">elementType</span><span class="o">.</span><span class="na">getKind</span><span class="o">()</span> <span class="o">==</span> <span class="nc">TypeKind</span><span class="o">.</span><span class="na">ERROR</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">note</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s field with unresolved type (%s) "</span>
                                <span class="o">+</span> <span class="s">"must elsewhere be generated as a View or interface. (%s.%s)"</span><span class="o">,</span>
                        <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">elementType</span><span class="o">,</span> <span class="n">qualifiedName</span><span class="o">,</span> <span class="n">simpleName</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s fields must extend from View or be an interface. (%s.%s)"</span><span class="o">,</span>
                        <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">qualifiedName</span><span class="o">,</span> <span class="n">simpleName</span><span class="o">);</span>
                <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// å­˜åœ¨é”™è¯¯åˆ™ç›´æ¥è¿”å›</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hasError</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
		<span class="o">....</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>è®¿é—®æƒé™æ£€æŸ¥: å±æ€§æˆ–è€…æ–¹æ³•çš„è®¿é—®æƒé™ä¸èƒ½ä¸ºprivateæˆ–è€…static</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åˆ¤æ–­è®¿é—®æƒé™æ˜¯å¦åˆæ³•</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isInaccessibleViaGeneratedCode</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">annotationClass</span><span class="o">,</span>
                                                <span class="nc">String</span> <span class="n">targetThing</span><span class="o">,</span> <span class="nc">Element</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">hasError</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
     <span class="nc">TypeElement</span> <span class="n">enclosingElement</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeElement</span><span class="o">)</span> <span class="n">element</span><span class="o">.</span><span class="na">getEnclosingElement</span><span class="o">();</span>

        <span class="c1">//å±æ€§æˆ–è€…æ–¹æ³•çš„è®¿é—®æƒé™ä¸èƒ½æ˜¯privateæˆ–è€…static</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Modifier</span><span class="o">&gt;</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">modifiers</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="no">PRIVATE</span><span class="o">)</span> <span class="o">||</span> <span class="n">modifiers</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="no">STATIC</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s %s must not be private or static. (%s.%s)"</span><span class="o">,</span>
                    <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">targetThing</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span>
                    <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
            <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// å…ƒç´ çš„çˆ¶å…ƒç´ å¿…é¡»ä¸ºç±»</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">enclosingElement</span><span class="o">.</span><span class="na">getKind</span><span class="o">()</span> <span class="o">!=</span> <span class="no">CLASS</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">error</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">,</span> <span class="s">"@%s %s may only be contained in classes. (%s.%s)"</span><span class="o">,</span>
                    <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">targetThing</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span>
                    <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
            <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// ç±»å…ƒç´ ä¸èƒ½ä¸ºprivate</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">enclosingElement</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="no">PRIVATE</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">error</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">,</span> <span class="s">"@%s %s may not be contained in private classes. (%s.%s)"</span><span class="o">,</span>
                    <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">targetThing</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span>
                    <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
            <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">hasError</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div>    </div>

    <p>æ³¨è§£ä¿®é¥°å±æ€§å¯¹åº”çš„ç±»åˆæ³•æ€§ï¼š è¢«æ³¨è§£ä¿®é¥°çš„å±æ€§å¯¹åº”çš„ç±»ä¸èƒ½ä¸ºç³»ç»Ÿç±»</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ˜¯å¦ç»‘å®šçš„ç±»ä¸åˆæ³•ï¼Œæ— æ³•ç»‘å®šç³»ç»Ÿç±»</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isBindingInWrongPackage</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">annotationClass</span><span class="o">,</span>
                                         <span class="nc">Element</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">TypeElement</span> <span class="n">enclosingElement</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeElement</span><span class="o">)</span> <span class="n">element</span><span class="o">.</span><span class="na">getEnclosingElement</span><span class="o">();</span>
     <span class="nc">String</span> <span class="n">qualifiedName</span> <span class="o">=</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

        <span class="c1">//åªè¦è¢«æ³¨è§£ä¿®é¥°å±æ€§å¯¹åº”çš„ç±»ä¸ºç³»ç»Ÿç›¸å…³ç±»åˆ™ä¸ºä¸åˆæ³•</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">qualifiedName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"android."</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s-annotated class incorrectly in Android framework package. (%s)"</span><span class="o">,</span>
                    <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">qualifiedName</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">qualifiedName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"java."</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s-annotated class incorrectly in Java framework package. (%s)"</span><span class="o">,</span>
                    <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">qualifiedName</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div>    </div>

    <p>æ³¨è§£ä¿®é¥°çš„å±æ€§ç±»å‹åˆæ³•æ€§ï¼šè¢«BindViewä¿®é¥°çš„å…ƒç´ éœ€è¦æ˜¯Viewçš„å­ç±»æˆ–è€…æ¥å£</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// å¾—åˆ°ç±»å…ƒç´ çš„å…¨å</span>
    <span class="nc">Name</span> <span class="n">qualifiedName</span> <span class="o">=</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">();</span>
 <span class="c1">// å¾—åˆ°å±æ€§çš„åå­—</span>
    <span class="nc">Name</span> <span class="n">simpleName</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
 <span class="k">if</span> <span class="o">(!</span><span class="n">isSubtypeOfType</span><span class="o">(</span><span class="n">elementType</span><span class="o">,</span> <span class="no">VIEW_TYPE</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isInterface</span><span class="o">(</span><span class="n">elementType</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// è‹¥å½“å‰ç±»ä¸æ˜¯Viewç±»çš„å­ç±»å¹¶ä¸”ç±»å‹å…ƒç´ ä¸æ˜¯æ¥å£</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">elementType</span><span class="o">.</span><span class="na">getKind</span><span class="o">()</span> <span class="o">==</span> <span class="nc">TypeKind</span><span class="o">.</span><span class="na">ERROR</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">note</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s field with unresolved type (%s) "</span>
             <span class="o">+</span> <span class="s">"must elsewhere be generated as a View or interface. (%s.%s)"</span><span class="o">,</span>
             <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">elementType</span><span class="o">,</span> <span class="n">qualifiedName</span><span class="o">,</span> <span class="n">simpleName</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s fields must extend from View or be an interface. (%s.%s)"</span><span class="o">,</span>
              <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">qualifiedName</span><span class="o">,</span> <span class="n">simpleName</span><span class="o">);</span>
        <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>å°†è¢«æ³¨è§£çš„å±æ€§ä¿¡æ¯ä¿å­˜</p>
  </li>
</ol>

<p>å¯¹æ³¨è§£çš„åˆæ³•æ€§æ£€æŸ¥å®Œä¹‹åï¼Œå°±æ˜¯è¦å–å‡ºæ³¨è§£é‡Œçš„å¸ƒå±€idä»¥åŠå¯¹åº”å±æ€§çš„ä¿¡æ¯ï¼Œå°†å…¶ä¿å­˜èµ·æ¥</p>

<ul>
  <li>åœ¨ç¼“å­˜ä¸­å¯»æ‰¾å½“å‰å±æ€§å¯¹åº”çš„ç±»æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™æ ¡éªŒå¯¹åº”çš„idæ˜¯å¦é‡å¤ç»‘å®šï¼›è‹¥ä¸å­˜åœ¨ï¼Œåˆ›å»ºå½“å‰å±æ€§å¯¹åº”ç±»çš„BindingSet</li>
  <li>å°†å¸ƒå±€idä»¥åŠè¢«æ³¨è§£ä¿®é¥°å±æ€§çš„ä¿¡æ¯åŒ…è£…æˆFieldViewBindingï¼Œå¹¶å°†è¯¥åŒ…è£…ç±»åŠ å…¥åˆ°BindingSetä¸­</li>
  <li>å°†è¢«æ³¨è§£ä¿®é¥°å±æ€§çš„çˆ¶å…ƒç´ (ä¹Ÿå°±æ˜¯ç±»å…ƒç´ )ä¿å­˜èµ·æ¥</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å¾—åˆ°BindViewå†…çš„idå€¼</span>
<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">value</span><span class="o">();</span>
<span class="c1">//åœ¨ç¼“å­˜ä¸­å–å‡ºBindingSet</span>
<span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">builderMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">);</span>
<span class="c1">// å°†idå€¼å°è£…æˆIdå¯¹è±¡</span>
<span class="nc">Id</span> <span class="n">resourceId</span> <span class="o">=</span> <span class="n">elementToId</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">builder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//å·²ç»å­˜åœ¨ç±»ä¿¡æ¯åŒ…è£…ç±»</span>
  <span class="nc">String</span> <span class="n">existingBindingName</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">findExistingBindingName</span><span class="o">(</span><span class="n">resourceId</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">existingBindingName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// è¯¥èµ„æºidå·²ç»è¢«ç»‘å®šè¿‡äº†</span>
    <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"Attempt to use @%s for an already bound ID %d on '%s'. (%s.%s)"</span><span class="o">,</span>
          <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">id</span><span class="o">,</span> <span class="n">existingBindingName</span><span class="o">,</span>
          <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
    <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
  <span class="c1">//ä¸å­˜åœ¨åˆ™åˆ›å»º</span>
  <span class="n">builder</span> <span class="o">=</span> <span class="n">getOrCreateBindingBuilder</span><span class="o">(</span><span class="n">builderMap</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">);</span>
<span class="o">}</span>

<span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">simpleName</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="nc">TypeName</span> <span class="n">type</span> <span class="o">=</span> <span class="nc">TypeName</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">elementType</span><span class="o">);</span>
<span class="c1">// åˆ¤æ–­å­—æ®µçš„æ˜¯æ˜¯å¦èƒ½ä¸ºç©º</span>
<span class="kt">boolean</span> <span class="n">required</span> <span class="o">=</span> <span class="n">isFieldRequired</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
<span class="c1">// å°†å­—æ®µä¿¡æ¯æ·»åŠ åˆ°ç±»ä¿¡æ¯åŒ…è£…ç±»ä¸­</span>
<span class="n">builder</span><span class="o">.</span><span class="na">addField</span><span class="o">(</span><span class="n">resourceId</span><span class="o">,</span> <span class="k">new</span> <span class="nc">FieldViewBinding</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">required</span><span class="o">));</span>

<span class="c1">//å°†è¢«æ³¨è§£çš„å…ƒç´ çš„ç±»å…ƒç´ ä¿å­˜èµ·æ¥</span>
<span class="n">erasedTargetNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">);</span>
</code></pre></div></div>

<p>å®Œæ•´ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseBindView</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">builderMap</span><span class="o">,</span>
                               <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">erasedTargetNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//å¾—åˆ°å½“å‰å­—æ®µå…ƒç´ çš„ä¸Šçº§ç±»å…ƒç´ </span>
        <span class="nc">TypeElement</span> <span class="n">enclosingElement</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeElement</span><span class="o">)</span> <span class="n">element</span><span class="o">.</span><span class="na">getEnclosingElement</span><span class="o">();</span>

        <span class="c1">//åˆ¤æ–­å…ƒç´ çš„è®¿é—®æƒé™çš„åˆæ³•æ€§ä»¥åŠæ˜¯å¦åˆ¤æ–­åœ¨ç³»ç»Ÿçš„apiç±»ä¸­ä½¿ç”¨äº†ButterKnifeæ³¨è§£</span>
        <span class="kt">boolean</span> <span class="n">hasError</span> <span class="o">=</span> <span class="n">isInaccessibleViaGeneratedCode</span><span class="o">(</span><span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"fields"</span><span class="o">,</span> <span class="n">element</span><span class="o">)</span>
                <span class="o">||</span> <span class="n">isBindingInWrongPackage</span><span class="o">(</span><span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>

        <span class="c1">// å¦‚æœæ³¨è§£ä¿®é¥°çš„æ˜¯æ³›å‹</span>
        <span class="nc">TypeMirror</span> <span class="n">elementType</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">asType</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">elementType</span><span class="o">.</span><span class="na">getKind</span><span class="o">()</span> <span class="o">==</span> <span class="nc">TypeKind</span><span class="o">.</span><span class="na">TYPEVAR</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/**
             *  æ‰¾åˆ°æ³›å‹ç±»å‹çš„ä¸Šç•Œ ä¾‹å¦‚
             * @BindView(R.id.xx)
             * T view;
             * å…¶ä¸­Tçš„ç±»å‹ä¸º ? extend View
             */</span>
            <span class="nc">TypeVariable</span> <span class="n">typeVariable</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeVariable</span><span class="o">)</span> <span class="n">elementType</span><span class="o">;</span>
            <span class="n">elementType</span> <span class="o">=</span> <span class="n">typeVariable</span><span class="o">.</span><span class="na">getUpperBound</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// å¾—åˆ°ç±»å…ƒç´ çš„å…¨å</span>
        <span class="nc">Name</span> <span class="n">qualifiedName</span> <span class="o">=</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">();</span>
        <span class="c1">// å¾—åˆ°å±æ€§çš„åå­—</span>
        <span class="nc">Name</span> <span class="n">simpleName</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isSubtypeOfType</span><span class="o">(</span><span class="n">elementType</span><span class="o">,</span> <span class="no">VIEW_TYPE</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isInterface</span><span class="o">(</span><span class="n">elementType</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// è‹¥å½“å‰ç±»ä¸æ˜¯Viewç±»çš„å­ç±»å¹¶ä¸”ç±»å‹å…ƒç´ ä¸æ˜¯æ¥å£</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">elementType</span><span class="o">.</span><span class="na">getKind</span><span class="o">()</span> <span class="o">==</span> <span class="nc">TypeKind</span><span class="o">.</span><span class="na">ERROR</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">note</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s field with unresolved type (%s) "</span>
                                <span class="o">+</span> <span class="s">"must elsewhere be generated as a View or interface. (%s.%s)"</span><span class="o">,</span>
                        <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">elementType</span><span class="o">,</span> <span class="n">qualifiedName</span><span class="o">,</span> <span class="n">simpleName</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s fields must extend from View or be an interface. (%s.%s)"</span><span class="o">,</span>
                        <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">qualifiedName</span><span class="o">,</span> <span class="n">simpleName</span><span class="o">);</span>
                <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// å­˜åœ¨é”™è¯¯åˆ™ç›´æ¥è¿”å›</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hasError</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// å¾—åˆ°BindViewå†…çš„idå€¼</span>
        <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">value</span><span class="o">();</span>
        <span class="c1">//åœ¨ç¼“å­˜ä¸­å–å‡ºBindingSet</span>
        <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">builderMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">);</span>
        <span class="c1">// å°†idå€¼å°è£…æˆIdå¯¹è±¡</span>
        <span class="nc">Id</span> <span class="n">resourceId</span> <span class="o">=</span> <span class="n">elementToId</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">builder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//å·²ç»å­˜åœ¨ç±»ä¿¡æ¯åŒ…è£…ç±»</span>
            <span class="nc">String</span> <span class="n">existingBindingName</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">findExistingBindingName</span><span class="o">(</span><span class="n">resourceId</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">existingBindingName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//ä¹‹å‰å·²ç»æ·»åŠ äº†å­—æ®µä¿¡æ¯</span>
                <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"Attempt to use @%s for an already bound ID %d on '%s'. (%s.%s)"</span><span class="o">,</span>
                        <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">id</span><span class="o">,</span> <span class="n">existingBindingName</span><span class="o">,</span>
                        <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">//ä¸å­˜åœ¨åˆ™åˆ›å»º</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">getOrCreateBindingBuilder</span><span class="o">(</span><span class="n">builderMap</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">simpleName</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="nc">TypeName</span> <span class="n">type</span> <span class="o">=</span> <span class="nc">TypeName</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">elementType</span><span class="o">);</span>
        <span class="c1">// åˆ¤æ–­å­—æ®µçš„æ˜¯æ˜¯å¦èƒ½ä¸ºç©º</span>
        <span class="kt">boolean</span> <span class="n">required</span> <span class="o">=</span> <span class="n">isFieldRequired</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
        <span class="c1">// å°†å­—æ®µä¿¡æ¯æ·»åŠ åˆ°ç±»ä¿¡æ¯åŒ…è£…ç±»ä¸­</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">addField</span><span class="o">(</span><span class="n">resourceId</span><span class="o">,</span> <span class="k">new</span> <span class="nc">FieldViewBinding</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">required</span><span class="o">));</span>

        <span class="c1">//å°†è¢«æ³¨è§£çš„å…ƒç´ çš„ç±»å…ƒç´ ä¿å­˜èµ·æ¥</span>
        <span class="n">erasedTargetNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å°ç»“ï¼š</p>

<ul>
  <li>è§£æBindViewæ³¨è§£é¦–å…ˆä¼šæ ¡éªŒæ³¨è§£çš„åˆæ³•æ€§ï¼Œä¾æ¬¡æ˜¯æƒé™åˆæ³•æ€§ï¼Œç±»åˆæ³•æ€§ï¼Œç±»å‹åˆæ³•æ€§ï¼Œä¸åˆæ³•åˆ™è¿”å›</li>
  <li>åˆ¤æ–­ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨å±æ€§å¯¹åº”ç±»çš„BindingSetï¼ˆViewBindingæè¿°ä¿¡æ¯ï¼‰ï¼Œå­˜åœ¨åˆ™éœ€è¦åˆ¤æ–­idæ˜¯å¦è¢«é‡å¤ç»‘å®šï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º</li>
  <li>å°†BindViewçš„å€¼ä»¥åŠå¯¹åº”ä¿®é¥°å±æ€§çš„ä¿¡æ¯å°è£…æˆFieldViewBindingåŠ å…¥åˆ°BindingSetä¸­</li>
</ul>

<p>è§£æå®Œæ‰€æœ‰çš„æ³¨è§£ä¹‹åï¼Œä¼šå¾—åˆ°ä¸€ä¸ªMapï¼Œè¿™ä¸ªMapçš„Keyä¸ºè¢«ButterKnifeæ³¨è§£ä¿®é¥°çš„ç±»å…ƒç´ ï¼ŒValueä¸ºViewBindingç±»ä¿¡æ¯åŒ…è£…ç±»ã€‚åœ¨ä½¿ç”¨ButterKnifeæ—¶ï¼Œæˆ‘ä»¬ä¸ºäº†ä¸ç”¨æ¯æ¬¡éƒ½ä¹¦å†™ButterKnife.bindæ–¹æ³•ï¼Œé€šå¸¸ä¼šæŠŠè¿™äº›ä»£ç æ”¾åœ¨BaseActivityä¸­ï¼Œæˆ–è€…åœ¨çˆ¶ç±»ä¸­ç»‘å®šä¸€äº›å…¬æœ‰çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨çˆ¶ç±»å’Œå­ç±»åŒæ—¶ä½¿ç”¨ButterKnifeæ³¨è§£çš„æƒ…å†µã€‚å› æ­¤æˆ‘ä»¬ç”Ÿæˆçš„ViewBindingç±»ä¹Ÿä¼šå­˜åœ¨ä¸€äº›ç»§æ‰¿å…³ç³»ï¼Œæ‰€ä»¥éœ€è¦ä¸ºæ¯ä¸€ä¸ªViewBindingç±»ç¡®å®šå…¶ç»§æ‰¿å…³ç³»ï¼Œæ‰¾åˆ°å®ƒå¯èƒ½å­˜åœ¨çš„çˆ¶ç±»ã€‚</p>

<ul>
  <li>æ‰¾åˆ°æ‰€æœ‰å­˜åœ¨å±æ€§è¢«æ³¨è§£ä¿®é¥°çš„çˆ¶ç±»å…ƒç´ </li>
  <li>ä¸ºæ¯ä¸€ä¸ªå…ƒç´ å’Œå­˜åœ¨çš„çˆ¶å…ƒç´ å»ºç«‹å¯¹åº”å…³ç³»ï¼Œæœ€ç»ˆå¾—åˆ°æ‰€æœ‰çš„ViewBindingä¿¡æ¯é›†åˆ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">&gt;</span> <span class="nf">findAndParseTargets</span><span class="o">(</span><span class="nc">RoundEnvironment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">...</span>
    <span class="c1">//è§£æå¤„ç†æ‰€æœ‰ButterKnifeæ³¨è§£</span>

<span class="c1">// æ‰¾åˆ°æ‰€æœ‰å­˜åœ¨å±æ€§è¢«æ³¨è§£ä¿®é¥°çš„çˆ¶ç±»å…ƒç´ </span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">ClasspathBindingSet</span><span class="o">&gt;</span> <span class="n">classpathBindings</span> <span class="o">=</span>
            <span class="n">findAllSupertypeBindings</span><span class="o">(</span><span class="n">builderMap</span><span class="o">,</span> <span class="n">erasedTargetNames</span><span class="o">);</span>

    <span class="c1">//æŠŠç±»ä¿¡æ¯åŒ…è£…é›†åˆæ”¾å…¥é˜Ÿåˆ—ä¸­</span>
    <span class="nc">Deque</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;&gt;</span> <span class="n">entries</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nc">ArrayDeque</span><span class="o">&lt;&gt;(</span><span class="n">builderMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">());</span>
    <span class="c1">// ä¸€ä¸ªç±»å¯¹åº”ä¸€ä¸ªç±»ä¿¡æ¯åŒ…è£…ç±»ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªä½¿ç”¨äº†ButterKnifeæ³¨è§£çš„ç±»å¯¹åº”viewBindingç±»çš„ä¿¡æ¯</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">&gt;</span> <span class="n">bindingMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="k">while</span> <span class="o">(!</span><span class="n">entries</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">//é˜Ÿåˆ—å¤´å‡ºåˆ—</span>
        <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">entries</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>

        <span class="nc">TypeElement</span> <span class="n">type</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
        <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>

        <span class="c1">//æŸ¥æ‰¾å½“å‰ç±»æ˜¯å¦å­˜åœ¨çˆ¶ç±»è¢«æ³¨è§£ä¿®é¥°</span>
        <span class="nc">TypeElement</span> <span class="n">parentType</span> <span class="o">=</span> <span class="n">findParentType</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">erasedTargetNames</span><span class="o">,</span> <span class="n">classpathBindings</span><span class="o">.</span><span class="na">keySet</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parentType</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//å½“å‰ç±»ä¸å­˜åœ¨çˆ¶ç±»ä½¿ç”¨äº†ButterKnifeæ³¨è§£ï¼Œç›´æ¥ä¿å­˜å½“å‰ç±»å…ƒç´ å’Œå¯¹åº”ç±»ä¿¡æ¯åŒ…è£…ç±»</span>
            <span class="n">bindingMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// å­˜åœ¨çˆ¶ç±»ä½¿ç”¨äº†ButterKnifeæ³¨è§£</span>
            <span class="nc">BindingInformationProvider</span> <span class="n">parentBinding</span> <span class="o">=</span> <span class="n">bindingMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">parentType</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">parentBinding</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">parentBinding</span> <span class="o">=</span> <span class="n">classpathBindings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">parentType</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">parentBinding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//ä¸ºå½“å‰viewBindingç±»è®¾ç½®çˆ¶ç±»ä¿¡æ¯</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">setParent</span><span class="o">(</span><span class="n">parentBinding</span><span class="o">);</span>
                <span class="n">bindingMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// å­˜åœ¨çˆ¶ç±»ä½¿ç”¨äº†æ³¨è§£çš„æƒ…å†µï¼Œä½†çˆ¶ç±»è¿˜æœªè¢«å¤„ç†ï¼Œé‡æ–°å°†å…ƒç´ åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨ï¼Œå»¶åå¤„ç†</span>
                <span class="n">entries</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="o">...</span>
    <span class="k">return</span> <span class="n">bindingMap</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="2-ç”Ÿæˆjavaä»£ç ">2. ç”ŸæˆJavaä»£ç </h4>

<p>åœ¨è§£æå¤„ç†æ³¨è§£åå¾—åˆ°äº†æ‰€æœ‰ViewBindingä¿¡æ¯é›†åˆï¼Œç°åœ¨éœ€è¦å°†è¿™äº›æ‰€æœ‰çš„ViewBindingç”Ÿæˆå…·ä½“çš„Javaä»£ç ã€‚</p>

<p>å¯ä»¥çœ‹åˆ°ä»£ç ä¸­éå†ç”Ÿæˆçš„é›†åˆï¼Œè°ƒç”¨BindingSetçš„brewJavaç”ŸæˆJavaä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">process</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">elements</span><span class="o">,</span> <span class="nc">RoundEnvironment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//å¯»æ‰¾å¹¶ä¸”è§£æè¢«æ³¨è§£ä¿®é¥°çš„å…ƒç´ ï¼Œè¿”å›ä¸€ä¸ªç±»å…ƒç´ ä¸å®ƒå¯¹åº”viewbindingç±»ä¿¡æ¯çš„ä¸€ä¸ªMap</span>
  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">&gt;</span> <span class="n">bindingMap</span> <span class="o">=</span> <span class="n">findAndParseTargets</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>

  <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">bindingMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">TypeElement</span> <span class="n">typeElement</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
    <span class="nc">BindingSet</span> <span class="n">binding</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
    <span class="c1">//ç”Ÿæˆè¢«æ³¨è§£ä¿®é¥°ç±»çš„viewbindingç±»Javaä»£ç </span>
    <span class="nc">JavaFile</span> <span class="n">javaFile</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">brewJava</span><span class="o">(</span><span class="n">sdk</span><span class="o">,</span> <span class="n">debuggable</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// å°†Javaç±»è¾“å‡ºåˆ°æ–‡ä»¶</span>
      <span class="n">javaFile</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">filer</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="n">typeElement</span><span class="o">,</span> <span class="s">"Unable to write binding for type %s: %s"</span><span class="o">,</span> <span class="n">typeElement</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿›å…¥brewJavaæ–¹æ³•ï¼Œè¿™é‡Œä½¿ç”¨äº†javapoetæ¡†æ¶æ¥ç”Ÿæˆä»£ç ï¼ŒcreateTypeæ–¹æ³•ç”¨äºç”Ÿæˆç±»ä¿¡æ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">JavaFile</span> <span class="nf">brewJava</span><span class="o">(</span><span class="kt">int</span> <span class="n">sdk</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">debuggable</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">TypeSpec</span> <span class="n">bindingConfiguration</span> <span class="o">=</span> <span class="n">createType</span><span class="o">(</span><span class="n">sdk</span><span class="o">,</span> <span class="n">debuggable</span><span class="o">);</span>
  <span class="k">return</span> <span class="nc">JavaFile</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="n">bindingClassName</span><span class="o">.</span><span class="na">packageName</span><span class="o">(),</span> <span class="n">bindingConfiguration</span><span class="o">)</span>
    <span class="o">.</span><span class="na">addFileComment</span><span class="o">(</span><span class="s">"Generated code from Butter Knife. Do not modify!"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿›å…¥createTypeæ–¹æ³•</p>

<p>æ‰§è¡Œæµç¨‹ï¼š</p>

<ol>
  <li>åˆ›å»ºç±»ç»“æ„ï¼Œè‹¥å­˜åœ¨çˆ¶ç±»åˆ™ç»§æ‰¿çˆ¶ç±»ï¼Œä¸å­˜åœ¨åˆ™å®ç°æ¥å£</li>
  <li>åˆ¤æ–­æ˜¯å¦éœ€è¦æ·»åŠ æˆå‘˜å±æ€§targetå­—æ®µï¼Œè¯¥å­—æ®µåœ¨ä½¿ç”¨äº†BindViewæˆ–è€…äº‹ä»¶ç›¸å…³æ³¨è§£æ—¶targetä¼šè¢«æ·»åŠ </li>
  <li>æ ¹æ®æ³¨å…¥çš„ç±»å‹æ·»åŠ åªæœ‰targetå½¢å‚çš„æ„é€ æ–¹æ³•</li>
  <li>åˆ¤æ–­åˆ›å»ºçš„æ„é€ æ–¹æ³•ä¸­æ˜¯å¦éœ€è¦æ·»åŠ Viewå½¢å‚ï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™é»˜è®¤æ·»åŠ ä¸€ä¸ªT_ViewBinding(T target, View source)ä¸¤ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•</li>
  <li>æ·»åŠ æœ€ç»ˆè¿›è¡Œä¾èµ–æ³¨å…¥å’Œäº‹ä»¶ç»‘å®šçš„æ„é€ æ–¹æ³•</li>
  <li>æ·»åŠ unbindæ–¹æ³•</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">TypeSpec</span> <span class="nf">createType</span><span class="o">(</span><span class="kt">int</span> <span class="n">sdk</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">debuggable</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//1. åˆ›å»ºç±»</span>
  <span class="nc">TypeSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">TypeSpec</span><span class="o">.</span><span class="na">classBuilder</span><span class="o">(</span><span class="n">bindingClassName</span><span class="o">.</span><span class="na">simpleName</span><span class="o">())</span>
    <span class="o">.</span><span class="na">addModifiers</span><span class="o">(</span><span class="no">PUBLIC</span><span class="o">)</span>
    <span class="o">.</span><span class="na">addOriginatingElement</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">isFinal</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addModifiers</span><span class="o">(</span><span class="no">FINAL</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">parentBinding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//å­˜åœ¨çˆ¶ç±»æ·»åŠ äº†ButterKnifeæ³¨è§£ï¼Œç”ŸæˆViewBindingç±»åŒæ ·ç»§æ‰¿çˆ¶ç±»å¯¹åº”çš„ViewBinding</span>
    <span class="n">result</span><span class="o">.</span><span class="na">superclass</span><span class="o">(</span><span class="n">parentBinding</span><span class="o">.</span><span class="na">getBindingClassName</span><span class="o">());</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">// ä¸å­˜åœ¨çˆ¶ç±»ï¼Œå®ç°Unbinderæ¥å£</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addSuperinterface</span><span class="o">(</span><span class="no">UNBINDER</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">//2. æ˜¯å¦åœ¨ViewBindingä¸­æ·»åŠ targetå±æ€§ï¼Œtargetæ˜¯æ³¨å…¥ç±»çš„åº”ç”¨ï¼Œåœ¨ä½¿ç”¨äº†BindViewæˆ–è€…äº‹ä»¶ç›¸å…³æ³¨è§£æ—¶targetä¼šè¢«æ·»åŠ </span>
  <span class="k">if</span> <span class="o">(</span><span class="n">hasTargetField</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addField</span><span class="o">(</span><span class="n">targetTypeName</span><span class="o">,</span> <span class="s">"target"</span><span class="o">,</span> <span class="no">PRIVATE</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">//3. åˆ›å»ºåªæœ‰targetå½¢å‚çš„æ„é€ æ–¹æ³•</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">isView</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">createBindingConstructorForView</span><span class="o">());</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isActivity</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">createBindingConstructorForActivity</span><span class="o">());</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isDialog</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">createBindingConstructorForDialog</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(!</span><span class="n">constructorNeedsView</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">// 4. å¦‚æœä¸€ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•ä¸­ä¸è¦ç”¨åˆ°view,åˆ›å»ºä¸€ä¸ªä¸¤ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œä¸€ä¸ªå‚æ•°ä¸ºtarget,å¦ä¸€ä¸ªä¸ºview</span>
    <span class="c1">// T_ViewBinding(T target, View source),ä¾‹å¦‚ç±»æ²¡æœ‰ä½¿ç”¨BindViewå’Œäº‹ä»¶ç›¸å…³æ³¨è§£ï¼Œæ­¤æ—¶æ„é€ æ–¹æ³•ä¸­ä¸éœ€è¦ç”¨åˆ°Viewï¼Œæ­¤æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºè¿™ä¸ªä¸¤ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">createBindingViewDelegateConstructor</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="c1">//5. æ·»åŠ å…·ä½“ç»‘å®šå±æ€§ï¼Œæ–¹æ³•çš„æ„é€ æ–¹æ³•</span>
  <span class="n">result</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">createBindingConstructor</span><span class="o">(</span><span class="n">sdk</span><span class="o">,</span> <span class="n">debuggable</span><span class="o">));</span>

  <span class="c1">//6. æ·»åŠ unbindæ–¹æ³•</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">hasViewBindings</span><span class="o">()</span> <span class="o">||</span> <span class="n">parentBinding</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">createBindingUnbindMethod</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬è¿™è¾¹ç€é‡çœ‹ä¸‹ç¬¬5ä¸ªæ­¥éª¤ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæœ€çµ‚çš„æ„é€ æ–¹æ³•ï¼Œå…¶ä»–æ„é€ æ–¹æ³•éƒ½ä¼šè°ƒç”¨è¯¥æ„é€ æ–¹æ³•ã€‚è¯¥æ„é€ æ–¹æ³•æ˜¯çœŸæ­£è¿›è¡Œä¾èµ–æ³¨å…¥å’Œäº‹ä»¶ç»‘å®šçš„æ–¹æ³•ã€‚</p>

<p>æ‰§è¡Œæµç¨‹</p>

<ol>
  <li>é¦–å…ˆæ·»åŠ targetå½¢å‚ï¼Œè‹¥å­˜åœ¨äº‹ä»¶ç»‘å®šï¼Œåˆ™targetå‚æ•°éœ€è¦ç”¨finalä¿®é¥°ï¼Œå› ä¸ºäº‹ä»¶ç›‘å¬å™¨ä»¥åŒ¿åç±»æ–¹æ³•è®¾ç½®</li>
  <li>æ ¹æ®ç»‘å®šå‚æ•°æƒ…å†µé€‰æ‹©ç¬¬äºŒä¸ªå‚æ•°çš„ç±»å‹ï¼Œè‹¥åªæ˜¯èµ„æºç»‘å®šï¼Œåˆ™ç¬¬äºŒä¸ªå‚æ•°ä¸ºContextï¼Œè‹¥å­˜åœ¨æ§ä»¶æˆ–è€…æ–¹æ³•ç»‘å®šåˆ™ç¬¬äºŒä¸ªå‚æ•°ä¸ºView</li>
  <li>å¦‚æœå­˜åœ¨çˆ¶ç±»ï¼Œåˆ™æ·»åŠ è°ƒç”¨çˆ¶ç±»æ„é€ æ–¹æ³•çš„ä»£ç </li>
  <li>è‹¥æœ‰æ§ä»¶æˆ–è€…æ–¹æ³•ç»‘å®šï¼Œtargetä¸ºæˆå‘˜å±æ€§ï¼Œåˆ™éœ€è¦ç»™è¯¥targetå±æ€§èµ‹å€¼</li>
  <li>å­˜åœ¨æ§ä»¶ç»‘å®šï¼Œè¿›è¡Œæ§ä»¶å€¼æ³¨å…¥ä»¥åŠäº‹ä»¶ç»‘å®š</li>
  <li>å­˜åœ¨èµ„æºç»‘å®šï¼Œåˆ™è¿›è¡Œèµ„æºå€¼æ³¨å…¥</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">MethodSpec</span> <span class="nf">createBindingConstructor</span><span class="o">(</span><span class="kt">int</span> <span class="n">sdk</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">debuggable</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">MethodSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">constructor</span> <span class="o">=</span> <span class="nc">MethodSpec</span><span class="o">.</span><span class="na">constructorBuilder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">addAnnotation</span><span class="o">(</span><span class="no">UI_THREAD</span><span class="o">)</span>
    <span class="o">.</span><span class="na">addModifiers</span><span class="o">(</span><span class="no">PUBLIC</span><span class="o">);</span>

  <span class="c1">//1. æ·»åŠ targetå½¢å‚</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">hasMethodBindings</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">constructor</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="n">targetTypeName</span><span class="o">,</span> <span class="s">"target"</span><span class="o">,</span> <span class="no">FINAL</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">constructor</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="n">targetTypeName</span><span class="o">,</span> <span class="s">"target"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">//2. æ·»åŠ ç¬¬äºŒä¸ªå½¢å‚</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">constructorNeedsView</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">// æ·»åŠ Viewå½¢å‚</span>
    <span class="n">constructor</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="no">VIEW</span><span class="o">,</span> <span class="s">"source"</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">constructor</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="no">CONTEXT</span><span class="o">,</span> <span class="s">"context"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">hasUnqualifiedResourceBindings</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">// Aapt can change IDs out from underneath us, just suppress since all will work at runtime.</span>
    <span class="n">constructor</span><span class="o">.</span><span class="na">addAnnotation</span><span class="o">(</span><span class="nc">AnnotationSpec</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="nc">SuppressWarnings</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">addMember</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span> <span class="s">"$S"</span><span class="o">,</span> <span class="s">"ResourceType"</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">build</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">hasOnTouchMethodBindings</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">constructor</span><span class="o">.</span><span class="na">addAnnotation</span><span class="o">(</span><span class="nc">AnnotationSpec</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="no">SUPPRESS_LINT</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">addMember</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span> <span class="s">"$S"</span><span class="o">,</span> <span class="s">"ClickableViewAccessibility"</span><span class="o">)</span>
                              <span class="o">.</span><span class="na">build</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="c1">// 3. æ˜¯å¦å­˜åœ¨çˆ¶ç±»</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">parentBinding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//è¢«æ³¨è§£ç±»çš„ç±»å­˜åœ¨çˆ¶ç±»é¡µä½¿ç”¨äº†ButterKnifeæ³¨è§£</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">parentBinding</span><span class="o">.</span><span class="na">constructorNeedsView</span><span class="o">())</span> <span class="o">{</span>
      <span class="c1">//è°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•</span>
      <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"super(target, source)"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">constructorNeedsView</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"super(target, source.getContext())"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"super(target, context)"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">constructor</span><span class="o">.</span><span class="na">addCode</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
  <span class="o">}</span>

   <span class="c1">//4.æ·»åŠ targetå±æ€§çš„èµ‹å€¼</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">hasTargetField</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"this.target = target"</span><span class="o">);</span>
    <span class="n">constructor</span><span class="o">.</span><span class="na">addCode</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// 5. æ§ä»¶å’Œäº‹ä»¶ç»‘å®š</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">hasViewBindings</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hasViewLocal</span><span class="o">())</span> <span class="o">{</span>
      <span class="c1">//æ˜¯å¦è¦åˆ›å»ºViewçš„å±€éƒ¨å˜é‡ï¼Œä¸€èˆ¬æœ‰ç»™æ§ä»¶è®¾ç½®ç›‘å¬å™¨æ³¨è§£æ—¶ï¼Œä¼šç”Ÿæˆè¯¥å±€éƒ¨å˜é‡</span>
      <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$T view"</span><span class="o">,</span> <span class="no">VIEW</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// æ·»åŠ Viewæ§ä»¶çš„ç»‘å®šä»£ç </span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">ViewBinding</span> <span class="n">binding</span> <span class="o">:</span> <span class="n">viewBindings</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">addViewBinding</span><span class="o">(</span><span class="n">constructor</span><span class="o">,</span> <span class="n">binding</span><span class="o">,</span> <span class="n">debuggable</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// æ·»åŠ ä½¿ç”¨BindViewsç»‘å®šæ§ä»¶çš„ä»£ç </span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">FieldCollectionViewBinding</span> <span class="n">binding</span> <span class="o">:</span> <span class="n">collectionBindings</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$L"</span><span class="o">,</span> <span class="n">binding</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">debuggable</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">resourceBindings</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">constructor</span><span class="o">.</span><span class="na">addCode</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// 6. èµ„æºç»‘å®š</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">resourceBindings</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">constructorNeedsView</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$T context = source.getContext()"</span><span class="o">,</span> <span class="no">CONTEXT</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hasResourceBindingsNeedingResource</span><span class="o">(</span><span class="n">sdk</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$T res = context.getResources()"</span><span class="o">,</span> <span class="no">RESOURCES</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">ResourceBinding</span> <span class="n">binding</span> <span class="o">:</span> <span class="n">resourceBindings</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$L"</span><span class="o">,</span> <span class="n">binding</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">sdk</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="n">constructor</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™è¾¹åŒæ ·çœ‹ç¬¬5ä¸ªæ­¥éª¤ï¼Œå¯¹æ§ä»¶å’Œäº‹ä»¶çš„ç»‘å®šï¼Œè¿™è¾¹éå†æ‰€æœ‰éœ€è¦è¿›è¡Œæ³¨å…¥çš„æ§ä»¶ä¿¡æ¯ï¼Œä¸ºæ¯ä¸€ä¸ªæ³¨å…¥ç¼–å†™ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ·»åŠ Viewæ§ä»¶çš„ç»‘å®šä»£ç </span>
<span class="k">for</span> <span class="o">(</span><span class="nc">ViewBinding</span> <span class="n">binding</span> <span class="o">:</span> <span class="n">viewBindings</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">addViewBinding</span><span class="o">(</span><span class="n">constructor</span><span class="o">,</span> <span class="n">binding</span><span class="o">,</span> <span class="n">debuggable</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿›å…¥addViewBindingæ–¹æ³•ï¼Œè¿™è¾¹åˆ†äº†ä¸¤ç§æƒ…å†µ</p>

<ul>
  <li>åªå­˜åœ¨æ§ä»¶çš„ç»‘å®š</li>
  <li>å­˜åœ¨æ§ä»¶ç»‘å®šå’Œæ–¹æ³•çš„ç»‘å®š</li>
</ul>

<p>å¯¹æ§ä»¶çš„ç»‘å®šä¸»è¦æ˜¯é€šè¿‡ç¼–å†™findViewByIdçš„ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">addViewBinding</span><span class="o">(</span><span class="nc">MethodSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">result</span><span class="o">,</span> <span class="nc">ViewBinding</span> <span class="n">binding</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">debuggable</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">isSingleFieldBinding</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">//è‹¥åªæœ‰å±æ€§çš„ç»‘å®šï¼Œæ²¡æœ‰æ–¹æ³•çš„ç»‘å®š</span>
    <span class="nc">FieldViewBinding</span> <span class="n">fieldBinding</span> <span class="o">=</span> <span class="n">requireNonNull</span><span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">getFieldBinding</span><span class="o">());</span>

    <span class="c1">// å¯¹targetä¸­è¢«æ³¨è§£ä¿®é¥°çš„å±æ€§è¿›è¡Œèµ‹å€¼</span>

    <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"target.$L = "</span><span class="o">,</span> <span class="n">fieldBinding</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

    <span class="kt">boolean</span> <span class="n">requiresCast</span> <span class="o">=</span> <span class="n">requiresCast</span><span class="o">(</span><span class="n">fieldBinding</span><span class="o">.</span><span class="na">getType</span><span class="o">());</span>
    <span class="c1">//debug &amp;&amp; (requecast || isRequired)</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">debuggable</span> <span class="o">||</span> <span class="o">(!</span><span class="n">requiresCast</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fieldBinding</span><span class="o">.</span><span class="na">isRequired</span><span class="o">()))</span> <span class="o">{</span>
      <span class="c1">//å¦‚æœédebugçŠ¶æ€æˆ–è€…å­—æ®µä¸éœ€è¦è¿›è¡Œå¼ºè½¬å’Œå­—æ®µå¹¶ä¸”ä¸æ˜¯å¿…éœ€èµ‹å€¼</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">requiresCast</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//éœ€è¦å‘ä¸‹é€ å‹</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"($T) "</span><span class="o">,</span> <span class="n">fieldBinding</span><span class="o">.</span><span class="na">getType</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"source.findViewById($L)"</span><span class="o">,</span> <span class="n">binding</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">code</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">//debugæ¨¡å¼å¹¶ä¸”éœ€è¦å¼ºè½¬æˆ–è€…æ˜¯å‚æ•°æ˜¯å¿…éœ€èµ‹å€¼çš„</span>
      <span class="c1">//  Utils.findRequiredViewAsType(source,[id], "æè¿°", T)</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"$T.find"</span><span class="o">,</span> <span class="no">UTILS</span><span class="o">);</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fieldBinding</span><span class="o">.</span><span class="na">isRequired</span><span class="o">()</span> <span class="o">?</span> <span class="s">"RequiredView"</span> <span class="o">:</span> <span class="s">"OptionalView"</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">requiresCast</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"AsType"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"(source, $L"</span><span class="o">,</span> <span class="n">binding</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">code</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">fieldBinding</span><span class="o">.</span><span class="na">isRequired</span><span class="o">()</span> <span class="o">||</span> <span class="n">requiresCast</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//æ·»åŠ æè¿°</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">", $S"</span><span class="o">,</span> <span class="n">asHumanDescription</span><span class="o">(</span><span class="n">singletonList</span><span class="o">(</span><span class="n">fieldBinding</span><span class="o">)));</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">requiresCast</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//æ§ä»¶çš„ç±»å‹</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">", $T.class"</span><span class="o">,</span> <span class="n">fieldBinding</span><span class="o">.</span><span class="na">getRawType</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">")"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$L"</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
    <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// Viewå±æ€§æœ‰å€¼ç»‘å®šå¹¶ä¸”æœ‰äº‹ä»¶ç»‘å®š</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MemberViewBinding</span><span class="o">&gt;</span> <span class="n">requiredBindings</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">getRequiredBindings</span><span class="o">();</span>
  <span class="c1">// ç»™å±€éƒ¨viewå˜é‡èµ‹å€¼</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">debuggable</span> <span class="o">||</span> <span class="n">requiredBindings</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"view = source.findViewById($L)"</span><span class="o">,</span> <span class="n">binding</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">code</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">binding</span><span class="o">.</span><span class="na">isBoundToRoot</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"view = $T.findRequiredView(source, $L, $S)"</span><span class="o">,</span> <span class="no">UTILS</span><span class="o">,</span>
                        <span class="n">binding</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">code</span><span class="o">,</span> <span class="n">asHumanDescription</span><span class="o">(</span><span class="n">requiredBindings</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="c1">// æ·»åŠ å±æ€§ç»‘å®š</span>
  <span class="n">addFieldBinding</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">binding</span><span class="o">,</span> <span class="n">debuggable</span><span class="o">);</span>
  <span class="c1">//æ·»åŠ äº‹ä»¶ç»‘å®š</span>
  <span class="n">addMethodBindings</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">binding</span><span class="o">,</span> <span class="n">debuggable</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ¥ä¸‹æ¥çœ‹çœ‹äº‹ä»¶æ–¹æ³•çš„ç»‘å®šï¼Œè¿™è¾¹ä»£ç æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬æŒ‘ä¸»è¦çš„è®²</p>

<ul>
  <li>ä¸€ä¸ªViewå¯èƒ½ä¼šè®¾ç½®å¤šä¸ªäº‹ä»¶ç›‘å¬ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªforå¾ªç¯æ˜¯éå†å½“å‰Viewéœ€è¦æ³¨å†Œçš„æ‰€æœ‰äº‹ä»¶ï¼Œä¸ºæ¯ä¸€ä¸ªäº‹ä»¶åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„äº‹ä»¶åŒ¿åç±»ï¼Œç„¶åå°†äº‹ä»¶ç›‘å¬å™¨ç»‘å®šåˆ°æ§ä»¶ã€‚</li>
  <li>æ¯ä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨å¯èƒ½ä¼šæœ‰å¤šä¸ªå›è°ƒæ–¹æ³•ï¼Œå› æ­¤ç¬¬ç¬¬äºŒå±‚forå¾ªç¯å°±æ˜¯ç»™åŒ¿åäº‹ä»¶ç±»æ·»åŠ æ‰€æœ‰çš„å›è°ƒæ–¹æ³•</li>
  <li>åœ¨targetç±»ä¸­ï¼ŒåŒä¸€ä¸ªæ§ä»¶çš„idå¯ä»¥å¤šæ¬¡ç»‘å®šåœ¨ä¸åŒçš„æ–¹æ³•ä¸Šï¼Œå› æ­¤ç¬¬ä¸‰å±‚forå¾ªç¯å°±æ˜¯åœ¨äº‹ä»¶ç›‘å¬å™¨å›è°ƒæ–¹æ³•ä¸­å»å›è°ƒæ¯ä¸€ä¸ªtargetä¸­å½“å‰viewidç»‘å®šçš„æ–¹æ³•</li>
  <li>targetä¸­äº‹ä»¶ç»‘å®šçš„æ–¹æ³•å¯èƒ½ä¼šæœ‰å¤šä¸ªå½¢å‚ï¼Œæ‰€ä»¥ç¬¬å››å±‚å¾ªç¯æ˜¯ä¸ºäº†ç»™è°ƒç”¨targetçš„äº‹ä»¶ç»‘å®šæ–¹æ³•ä¼ å…¥çš„æ‰€æœ‰å‚æ•°</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">addMethodBindings</span><span class="o">(</span><span class="nc">MethodSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">result</span><span class="o">,</span> <span class="nc">ViewBinding</span> <span class="n">binding</span><span class="o">,</span>
                               <span class="kt">boolean</span> <span class="n">debuggable</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ListenerClass</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ListenerMethod</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodViewBinding</span><span class="o">&gt;&gt;&gt;</span> <span class="n">classMethodBindings</span> <span class="o">=</span>
            <span class="n">binding</span><span class="o">.</span><span class="na">getMethodBindings</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">classMethodBindings</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// æ§ä»¶æ˜¯å¦å¯ä»¥ä¸ºç©ºï¼Œä¸ºç©ºæ·»åŠ åˆ¤æ–­ä»£ç </span>
    <span class="kt">boolean</span> <span class="n">needsNullChecked</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">getRequiredBindings</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">needsNullChecked</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">beginControlFlow</span><span class="o">(</span><span class="s">"if (view != null)"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// å¯¹å­˜åœ¨äº‹ä»¶ç›‘å¬çš„æ§ä»¶éœ€è¦å°†æ§ä»¶è®¾ç½®ä¸ºæˆå‘˜å˜é‡ï¼Œä»¥ä¾¿åœ¨unbindåŠæ—¶ç§»é™¤æ§ä»¶çš„ç›‘å¬å™¨</span>
    <span class="nc">String</span> <span class="n">fieldName</span> <span class="o">=</span> <span class="s">"viewSource"</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">bindName</span> <span class="o">=</span> <span class="s">"source"</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">binding</span><span class="o">.</span><span class="na">isBoundToRoot</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">fieldName</span> <span class="o">=</span> <span class="s">"view"</span> <span class="o">+</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">value</span><span class="o">);</span>
        <span class="n">bindName</span> <span class="o">=</span> <span class="s">"view"</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// ç»™æˆå‘˜å˜é‡èµ‹å€¼</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$L = $N"</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">,</span> <span class="n">bindName</span><span class="o">);</span>

    <span class="c1">//1. ä¸ºå½“å‰viewè®¾ç½®äº‹ä»¶ç›‘å¬ï¼Œéå†æ‰€æœ‰è®¾ç½®çš„ç›‘å¬æ–¹æ³•</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">ListenerClass</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ListenerMethod</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodViewBinding</span><span class="o">&gt;&gt;&gt;</span> <span class="n">e</span>
            <span class="o">:</span> <span class="n">classMethodBindings</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">ListenerClass</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ListenerMethod</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodViewBinding</span><span class="o">&gt;&gt;</span> <span class="n">methodBindings</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>

        <span class="c1">//åˆ›å»ºä¸€ä¸ªäº‹ä»¶åŒ¿åç±»</span>
        <span class="nc">TypeSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">callback</span> <span class="o">=</span> <span class="nc">TypeSpec</span><span class="o">.</span><span class="na">anonymousClassBuilder</span><span class="o">(</span><span class="s">""</span><span class="o">)</span>
                <span class="o">.</span><span class="na">superclass</span><span class="o">(</span><span class="nc">ClassName</span><span class="o">.</span><span class="na">bestGuess</span><span class="o">(</span><span class="n">listener</span><span class="o">.</span><span class="na">type</span><span class="o">()));</span>

        <span class="c1">//2. ç»™äº‹ä»¶åŒ¿åç±»çš„æ‰€æœ‰å›è°ƒæ–¹æ³•ç»‘å®šæ–¹æ³•</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">ListenerMethod</span> <span class="n">method</span> <span class="o">:</span> <span class="n">getListenerMethods</span><span class="o">(</span><span class="n">listener</span><span class="o">))</span> <span class="o">{</span>

            <span class="c1">// äº‹ä»¶ç›‘å¬å™¨æ¥å£éœ€è¦å®ç°çš„æ–¹æ³•</span>
            <span class="nc">MethodSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">callbackMethod</span> <span class="o">=</span> <span class="nc">MethodSpec</span><span class="o">.</span><span class="na">methodBuilder</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">addAnnotation</span><span class="o">(</span><span class="nc">Override</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addModifiers</span><span class="o">(</span><span class="no">PUBLIC</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">returns</span><span class="o">(</span><span class="n">bestGuess</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">returnType</span><span class="o">()));</span>
            <span class="c1">// æ·»åŠ æ–¹æ³•å½¢å‚</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">parameters</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">callbackMethod</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="n">bestGuess</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">]),</span> <span class="s">"p"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kt">boolean</span> <span class="n">hasReturnValue</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">builder</span><span class="o">();</span>
            <span class="c1">//å¾—åˆ°éœ€è¦ç»‘å®šçš„æ–¹æ³•</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodViewBinding</span><span class="o">&gt;</span> <span class="n">methodViewBindings</span> <span class="o">=</span> <span class="n">methodBindings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">methodViewBindings</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//3. åœ¨æ¥å£å®ç°æ–¹æ³•ä¸­è°ƒç”¨éœ€è¦targetä¸­å¯¹ç”¨çš„å›è°ƒæ–¹æ³•</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">MethodViewBinding</span> <span class="n">methodBinding</span> <span class="o">:</span> <span class="n">methodViewBindings</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">methodBinding</span><span class="o">.</span><span class="na">hasReturnValue</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">hasReturnValue</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"return "</span><span class="o">);</span> <span class="c1">// TODO what about multiple methods?</span>
                    <span class="o">}</span>
                    <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"target.$L("</span><span class="o">,</span> <span class="n">methodBinding</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Parameter</span><span class="o">&gt;</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">methodBinding</span><span class="o">.</span><span class="na">getParameters</span><span class="o">();</span>
                    <span class="nc">String</span><span class="o">[]</span> <span class="n">listenerParameters</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">parameters</span><span class="o">();</span>
                    <span class="c1">//4. æ·»åŠ æ–¹æ³•å‚æ•°</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">", "</span><span class="o">);</span>
                        <span class="o">}</span>

                        <span class="nc">Parameter</span> <span class="n">parameter</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                        <span class="kt">int</span> <span class="n">listenerPosition</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="na">getListenerPosition</span><span class="o">();</span>

                        <span class="k">if</span> <span class="o">(</span><span class="n">parameter</span><span class="o">.</span><span class="na">requiresCast</span><span class="o">(</span><span class="n">listenerParameters</span><span class="o">[</span><span class="n">listenerPosition</span><span class="o">]))</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">debuggable</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"$T.castParam(p$L, $S, $L, $S, $L, $T.class)"</span><span class="o">,</span> <span class="no">UTILS</span><span class="o">,</span>
                                        <span class="n">listenerPosition</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span> <span class="n">listenerPosition</span><span class="o">,</span> <span class="n">methodBinding</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">i</span><span class="o">,</span>
                                        <span class="n">parameter</span><span class="o">.</span><span class="na">getType</span><span class="o">());</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"($T) p$L"</span><span class="o">,</span> <span class="n">parameter</span><span class="o">.</span><span class="na">getType</span><span class="o">(),</span> <span class="n">listenerPosition</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"p$L"</span><span class="o">,</span> <span class="n">listenerPosition</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">");\n"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(!</span><span class="s">"void"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">returnType</span><span class="o">())</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hasReturnValue</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"return $L;\n"</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">defaultReturn</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="n">callbackMethod</span><span class="o">.</span><span class="na">addCode</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="n">callback</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">callbackMethod</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="n">requiresRemoval</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="na">remover</span><span class="o">().</span><span class="na">length</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">listenerField</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">requiresRemoval</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">TypeName</span> <span class="n">listenerClassName</span> <span class="o">=</span> <span class="n">bestGuess</span><span class="o">(</span><span class="n">listener</span><span class="o">.</span><span class="na">type</span><span class="o">());</span>
            <span class="n">listenerField</span> <span class="o">=</span> <span class="n">fieldName</span> <span class="o">+</span> <span class="o">((</span><span class="nc">ClassName</span><span class="o">)</span> <span class="n">listenerClassName</span><span class="o">).</span><span class="na">simpleName</span><span class="o">();</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$L = $L"</span><span class="o">,</span> <span class="n">listenerField</span><span class="o">,</span> <span class="n">callback</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>

         <span class="c1">//ç»™æ§ä»¶è®¾ç½®äº‹ä»¶ç›‘å¬å™¨</span>
        <span class="nc">String</span> <span class="n">targetType</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="na">targetType</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="no">VIEW_TYPE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">targetType</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">//ä¸æ˜¯view,åˆ™éœ€è¦å¼ºè½¬ä¸ºæŒ‡å®šç±»å‹</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"(($T) $N).$L($L)"</span><span class="o">,</span> <span class="n">bestGuess</span><span class="o">(</span><span class="n">targetType</span><span class="o">),</span> <span class="n">bindName</span><span class="o">,</span>
                    <span class="n">listener</span><span class="o">.</span><span class="na">setter</span><span class="o">(),</span> <span class="n">requiresRemoval</span> <span class="o">?</span> <span class="n">listenerField</span> <span class="o">:</span> <span class="n">callback</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$N.$L($L)"</span><span class="o">,</span> <span class="n">bindName</span><span class="o">,</span> <span class="n">listener</span><span class="o">.</span><span class="na">setter</span><span class="o">(),</span>
                    <span class="n">requiresRemoval</span> <span class="o">?</span> <span class="n">listenerField</span> <span class="o">:</span> <span class="n">callback</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">needsNullChecked</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">endControlFlow</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è‡³æ­¤BindViewæ³¨è§£è§£æä»¥åŠå¯¹åº”ViewBindingç±»ä»£ç ç”Ÿæˆæ•´ä¸ªæµç¨‹å°±è¿™æ ·å®Œæˆäº†ã€‚</p>
:ET